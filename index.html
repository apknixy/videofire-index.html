<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Fire</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google IMA SDK for VAST Ads -->
    <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlalHtskXv/FzP/rG2wR2M4Xk5pQ6O1Vf8T5mYF1iWk0K9a/8+f+g5mS8X4c6q+g6K0g6G0g6G0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Base styles for Inter font, dark background, and overflow handling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d; /* Deep dark background */
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll, main content will scroll */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Hide scrollbar for cleaner look */
        .hide-scrollbar::-webkit-scrollbar {
            display: none; /* For Chrome, Safari, Opera */
        }
        .hide-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Snap scrolling for video feed (Shorts style) */
        .snap-mandatory {
            scroll-snap-type: y mandatory;
        }
        .snap-center {
            scroll-snap-align: center;
        }

        /* Custom animation for temporary ad message */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .animate-fade-in-out {
            animation: fadeInOut 3s ease-in-out forwards;
        }

        /* Full screen ad container for IMA SDK (critical for VAST) */
        #ima-ad-container {
            width: 100vw;
            height: 100vh;
            position: fixed; /* Use fixed to ensure it covers everything */
            top: 0;
            left: 0;
            background-color: black;
            z-index: 200; /* Higher than other modals to ensure full screen dominance */
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        /* Ensure iframes are responsive */
        iframe {
            max-width: 100%;
            height: auto;
        }

        /* Custom toggle switch styling for monetization options */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4a5568; /* gray-600 */
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #f97316; /* orange-500 */
        }
        input:focus + .toggle-slider {
            box-shadow: 0 0 1px #f97316;
        }
        input:checked + .toggle-slider:before {
            -webkit-transform: translateX(20px);
            -ms-transform: translateX(20px);
            transform: translateX(20px);
        }

        /* Style for Shorts indicator on video cards */
        .short-indicator {
            position: absolute;
            top: 8px;
            left: 8px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Header search bar styling */
        .search-bar-container {
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 500px;
            background-color: #1a1a1a;
            border-radius: 20px;
            padding: 6px 12px;
            margin: 0 16px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }
        .search-bar-container input {
            flex-grow: 1;
            background-color: transparent;
            border: none;
            outline: none;
            color: white;
            padding: 4px 8px;
        }
        .search-bar-container button {
            background-color: transparent;
            border: none;
            color: #d1d5db; /* gray-300 */
            cursor: pointer;
            padding: 4px;
            transition: color 0.2s;
        }
        .search-bar-container button:hover {
            color: white;
        }

        /* Main content area padding for header and footer */
        main {
            padding-top: 70px; /* Space for fixed header */
            padding-bottom: 60px; /* Space for fixed footer */
            flex: 1; /* Allow main content to grow and take available space */
            overflow-y: auto; /* Enable scrolling for main content */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align content to top */
            width: 100%; /* Ensure it takes full width */
        }

        /* Specific styling for Shorts video cards to ensure proper aspect ratio and centering */
        #home-page.shorts-mode #video-feed-container > div {
            width: 100%;
            max-width: 400px; /* Max width for shorts on larger screens */
            height: calc(100vh - 130px); /* Adjust height for shorts, considering header/footer */
            aspect-ratio: 9/16;
            margin-left: auto;
            margin-right: auto;
            scroll-snap-align: center;
            border-radius: 1rem; /* rounded-xl */
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #home-page.shorts-mode #video-feed-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100%;
        }

        /* Ensure video player elements fill their container within the card */
        .video-player-container, .youtube-iframe-wrapper {
            width: 100%;
            height: 100%;
        }
        .video-player-container iframe {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensure video covers iframe */
        }

        /* Video card hover effects */
        .video-card-item {
            transform: scale(1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border-radius: 0.75rem; /* rounded-lg */
            overflow: hidden;
        }
        .video-card-item:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(249, 115, 22, 0.3); /* orange-500 shadow */
        }

        /* Buttons with gradients and shadows */
        .btn-primary {
            background-image: linear-gradient(to right, #f97316, #ef4444); /* orange-500 to red-500 */
            box-shadow: 0 4px 10px rgba(249, 115, 22, 0.4);
            transition: all 0.3s ease-in-out;
        }
        .btn-primary:hover {
            background-image: linear-gradient(to right, #ef4444, #f97316);
            box-shadow: 0 6px 15px rgba(249, 115, 22, 0.6);
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #4b5563; /* gray-700 */
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.3s ease-in-out;
        }
        .btn-secondary:hover {
            background-color: #6b7280; /* gray-600 */
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            transform: translateY(-1px);
        }

        /* Modal styling */
        .modal-content {
            background-color: #1f2937; /* gray-800 */
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            border: 1px solid #374151; /* gray-700 */
        }

        /* Input field focus styling */
        input:focus, textarea:focus {
            border-color: #f97316; /* orange-500 */
            outline: none;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.3);
        }

        /* Footer active button style */
        .footer-btn-active {
            color: #f97316; /* orange-500 */
            background-color: #1f2937; /* gray-800 */
            box-shadow: 0 -2px 10px rgba(249, 115, 22, 0.2);
        }

        /* Player container in video card */
        .video-card-item .player-container {
            position: relative;
            width: 100%;
            /* Fixed height for long videos, 9/16 aspect for shorts */
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
        }
        .video-card-item .player-container iframe,
        .video-card-item .player-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Specific styles for shorts player */
        #home-page.shorts-mode .video-card-item .player-container {
            padding-bottom: 177.77%; /* 9:16 Aspect Ratio (16 / 9 * 100) */
            height: calc(100% - 180px); /* Adjust based on info panel height */
        }
        #home-page.shorts-mode .video-card-item .video-info-overlay {
            height: 180px; /* Fixed height for info overlay */
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        .video-info-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0.5), transparent);
            color: white;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-950 text-white flex flex-col">

    <!-- Global Ad Container for IMA SDK (hidden by default) -->
    <!-- This container is crucial for full-screen VAST ad playback -->
    <div id="ima-ad-container" class="bg-black flex flex-col items-center justify-center">
        <div class="text-white text-lg font-bold mb-4 flex items-center">
            <svg class="animate-pulse h-6 w-6 mr-2 text-orange-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
            <span>Ad playing...</span>
        </div>
        <svg class="animate-spin h-8 w-8 text-orange-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <!-- Header Section -->
    <header class="fixed top-0 left-0 right-0 bg-gray-900 bg-opacity-90 backdrop-blur-sm p-4 flex items-center justify-between shadow-lg z-50 rounded-b-xl border-b border-gray-800">
        <div class="flex items-center space-x-3">
            <img src="https://placehold.co/40x40/FF7F50/FFFFFF?text=VF" alt="Video Fire Logo" class="rounded-full shadow-md" />
            <span class="text-2xl font-extrabold text-orange-500 drop-shadow-lg">Video Fire</span>
        </div>
        <!-- Search bar in header (hidden by default) -->
        <div id="header-search-container" class="search-bar-container hidden sm:flex">
            <input type="text" id="header-search-input" placeholder="Search by title, tags, or channel..." />
            <button id="clear-search-button" class="text-gray-400 hover:text-white">
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div id="header-buttons-container" class="flex items-center space-x-4">
            <button id="search-button" class="p-2 rounded-full hover:bg-gray-700 text-gray-300 transition duration-200 hidden sm:block" title="Search">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </button>
            <button id="withdraw-header-button" class="p-2 rounded-full bg-green-600 hover:bg-green-700 text-white transition duration-200 shadow-md" title="Withdraw">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
            </button>
            <button id="profile-header-button" class="p-2 rounded-full hover:bg-gray-700 text-gray-300 transition duration-200" title="Profile">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            </button>
            <div id="user-info" class="flex items-center space-x-2 text-sm text-gray-400 hidden">
                <span id="display-user-id" class="font-medium text-orange-300"></span>
                <button id="sign-out-button" class="px-3 py-1 rounded-md text-xs bg-red-600 hover:bg-red-700 text-white font-semibold transition duration-200">Sign Out</button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 w-full flex justify-center items-center overflow-hidden">
        <!-- Home Page (Main Video Feed for Long and Shorts) -->
        <div id="home-page" class="w-full h-full overflow-y-scroll snap-y snap-mandatory bg-gray-950 hide-scrollbar">
            <div id="video-feed-container" class="w-full h-full">
                <!-- Videos will be dynamically injected here -->
            </div>
            <div id="home-loading" class="flex flex-col items-center justify-center h-full text-white text-lg hidden">
                <svg class="animate-spin h-10 w-10 text-orange-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="ml-3 mt-4">Loading videos...</span>
            </div>
            <div id="home-error" class="flex items-center justify-center h-full text-red-500 text-center p-4 hidden text-lg"></div>
            <div id="no-videos-message" class="flex items-center justify-center h-full text-white text-lg hidden">
                No videos available. Upload some!
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profile-page" class="hidden p-6 bg-gray-950 w-full h-full overflow-y-auto hide-scrollbar">
            <div class="max-w-4xl mx-auto">
                <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-6 mb-8 bg-gray-900 p-6 rounded-xl shadow-lg border border-gray-800">
                    <img id="profile-avatar" src="https://placehold.co/100x100/374151/E5E7EB?text=U" alt="Profile Avatar" class="w-24 h-24 rounded-full border-4 border-orange-500 shadow-md" />
                    <div>
                        <h1 id="profile-username" class="text-3xl font-extrabold text-orange-400 mb-1"></h1>
                        <p class="text-gray-400">User ID: <span id="profile-user-id" class="break-all text-sm"></span></p>
                        <p class="text-gray-300 mt-2">Total Uploads: <span id="profile-uploads-count" class="font-semibold">0</span></p>
                    </div>
                </div>

                <!-- Profile Videos/Shorts Tabs -->
                <div class="flex border-b border-gray-700 mb-6">
                    <button id="profile-tab-videos" class="px-4 py-2 text-lg font-semibold border-b-2 border-orange-500 text-orange-500 transition-colors duration-200">Videos</button>
                    <button id="profile-tab-shorts" class="px-4 py-2 text-lg font-semibold border-b-2 border-transparent text-gray-400 hover:text-white hover:border-gray-500 transition-colors duration-200">Shorts</button>
                </div>

                <h2 class="text-2xl font-bold mb-6 text-orange-300">My Uploads</h2>
                <div id="user-videos-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- User videos will be injected here -->
                </div>
                <p id="no-user-videos-message" class="text-gray-400 text-center py-8 bg-gray-900 rounded-lg border border-gray-800 hidden">
                    You haven't uploaded any videos yet.
                </p>
                <div id="profile-loading" class="flex justify-center items-center h-48 text-white hidden text-lg">Loading profile...</div>
                <div id="profile-error" class="text-red-500 text-center mt-8 hidden text-lg"></div>
            </div>
        </div>

        <!-- Search Page (Placeholder - Actual search handled by updateVideoFeed) -->
        <div id="search-page" class="hidden flex items-center justify-center h-full w-full bg-gray-950 text-white text-3xl font-bold">
            Search Functionality Activated in Header!
        </div>
        <!-- People Page (Placeholder) -->
        <div id="people-page" class="hidden flex items-center justify-center h-full w-full bg-gray-950 text-white text-3xl font-bold">
            People/Follow Functionality Coming Soon!
        </div>

    </main>

    <!-- Footer Navigation -->
    <footer class="fixed bottom-0 left-0 right-0 bg-gray-900 bg-opacity-90 backdrop-blur-sm p-3 flex items-center justify-around shadow-lg z-50 rounded-t-xl border-t border-gray-800">
        <button id="home-footer-button" class="flex flex-col items-center p-2 rounded-lg transition duration-200 footer-btn-active">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l-7 7-7-7M19 10v10a1 1 0 01-1 1h-3"></path></svg>
            <span class="text-xs mt-1">Home</span>
        </button>
        <button id="shorts-footer-button" class="flex flex-col items-center p-2 rounded-lg transition duration-200 text-gray-400 hover:bg-gray-700">
            <i class="fa-solid fa-bolt h-6 w-6 text-2xl"></i>
            <span class="text-xs mt-1">Shorts</span>
        </button>
        <button id="upload-footer-button" class="flex flex-col items-center p-2 rounded-full btn-primary shadow-lg -mt-6">
            <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path></svg>
        </button>
        <button id="people-footer-button" class="flex flex-col items-center p-2 rounded-lg transition duration-200 text-gray-400 hover:bg-gray-700">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h2a2 2 0 002-2V4a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h2m0 0a2 2 0 100 4 2 2 0 000-4zm0 0H9m4 0h4m-4 0a2 2 0 100 4 2 2 0 000-4zm0 0H9"></path></svg>
            <span class="text-xs mt-1">People</span>
        </button>
        <button id="profile-footer-button" class="flex flex-col items-center p-2 rounded-lg transition duration-200 text-gray-400 hover:bg-gray-700">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            <span class="text-xs mt-1">You</span>
        </button>
    </footer>

    <!-- Custom Modal Structure -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1000] p-4 hidden">
        <div class="modal-content p-6 max-w-sm w-full text-center">
            <h3 id="custom-modal-title" class="text-xl font-bold mb-4 text-orange-400"></h3>
            <p id="custom-modal-message" class="mb-6 text-gray-300"></p>
            <div class="flex justify-center space-x-4">
                <button id="custom-modal-confirm-button" class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded-md font-semibold transition duration-200 hidden">Confirm</button>
                <button id="custom-modal-close-button" class="px-6 py-2 bg-red-600 hover:bg-red-700 rounded-md font-semibold transition duration-200">Close</button>
            </div>
        </div>
    </div>

    <!-- Comment Modal Structure -->
    <div id="comment-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-end justify-center z-[900] p-0 hidden">
        <div class="modal-content w-full max-w-lg h-3/4 rounded-t-2xl flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-gray-700 bg-gray-900">
                <h2 class="text-xl font-bold text-orange-400">Comments</h2>
                <button id="comment-modal-close-button" class="p-2 rounded-full hover:bg-gray-700 text-gray-300">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="comment-list" class="flex-1 overflow-y-auto p-4 hide-scrollbar">
                <div id="comment-loading" class="flex flex-col justify-center items-center h-full text-white hidden">
                    <svg class="animate-spin h-6 w-6 text-orange-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="ml-2 mt-2 text-gray-300">Loading comments...</span>
                </div>
                <p id="no-comments-message" class="text-gray-400 text-center mt-4 hidden">No comments yet. Be the first!</p>
                <!-- Comments will be injected here -->
            </div>
            <div class="p-4 border-t border-gray-700 bg-gray-900">
                <div class="flex space-x-2">
                    <input type="text" id="new-comment-input" class="flex-1 p-3 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 border border-gray-600" placeholder="Add a comment..." />
                    <button id="add-comment-button" class="px-5 py-3 btn-primary rounded-lg font-semibold text-white">Post</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Video Modal Structure -->
    <div id="upload-video-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[900] p-4 hidden">
        <div class="modal-content p-8 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-orange-400">Upload New Video</h2>
                <button id="upload-modal-close-button" class="p-2 rounded-full hover:bg-gray-700 text-gray-300">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="upload-video-form">
                <div class="mb-4">
                    <label for="video-url-input" class="block text-gray-300 text-sm font-semibold mb-2">YouTube Video URL:</label>
                    <input type="text" id="video-url-input" class="w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600" placeholder="e.g., https://youtu.be/WC2FUEmKEu8" required />
                </div>
                <div class="mb-4">
                    <label for="video-title-input" class="block text-gray-300 text-sm font-semibold mb-2">Video Title (Max 100 words):</label>
                    <input type="text" id="video-title-input" class="w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600" placeholder="Enter video title" maxlength="100" required />
                </div>
                <div class="mb-4">
                    <label for="video-description-input" class="block text-gray-300 text-sm font-semibold mb-2">Video Description:</label>
                    <textarea id="video-description-input" class="w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600" placeholder="Write about the video"></textarea>
                </div>
                <div class="mb-6">
                    <label for="video-tags-input" class="block text-gray-300 text-sm font-semibold mb-2">Tags (Comma-separated, Max 200 words):</label>
                    <input type="text" id="video-tags-input" class="w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600" placeholder="tag1, tag2, tag3" maxlength="200" />
                </div>

                <div class="mb-6">
                    <label class="block text-gray-300 text-sm font-semibold mb-2">Visibility:</label>
                    <div class="flex items-center space-x-4">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="video-visibility" value="public" class="form-radio text-orange-500" checked>
                            <span class="ml-2 text-gray-300">Public (Anyone can view)</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="video-visibility" value="private" class="form-radio text-orange-500">
                            <span class="ml-2 text-gray-300">Private (Only you)</span>
                        </label>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-300 text-sm font-semibold mb-2">Video Type:</label>
                    <div class="flex items-center space-x-4">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="video-type" value="long" class="form-radio text-orange-500" checked>
                            <span class="ml-2 text-gray-300">Long Video</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="video-type" value="short" class="form-radio text-orange-500">
                            <span class="ml-2 text-gray-300">Short Video</span>
                        </label>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-gray-300 text-sm font-semibold mb-3 border-b border-gray-700 pb-2">Monetization Settings (Ads for this video)</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <label for="monetize-vast" class="text-gray-300">VAST Ads (Pre-roll video ads)</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="monetize-vast" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="monetize-banner-468x60" class="text-gray-300">Banner Ad (468x60)</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="monetize-banner-468x60" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="monetize-banner-300x250" class="text-gray-300">Banner Ad (300x250) - Used for in-feed Shorts ads</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="monetize-banner-300x250" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="monetize-native" class="text-gray-300">Native Ads</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="monetize-native" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <p id="upload-error-message" class="text-red-500 text-sm mb-4 hidden"></p>
                <button type="submit" id="upload-submit-button" class="w-full py-3 btn-primary rounded-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="upload-button-text">Upload Video</span>
                    <svg id="upload-loading-spinner" class="animate-spin h-5 w-5 ml-3 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <!-- Withdraw Modal Structure -->
    <div id="withdraw-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[900] p-4 hidden">
        <div class="modal-content p-8 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-orange-400">Withdraw Earnings</h2>
                <button id="withdraw-modal-close-button" class="p-2 rounded-full hover:bg-gray-700 text-gray-300">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <p class="text-gray-300 text-sm mb-4">
                Minimum withdrawal amount: ₹100. Payments are sent manually via UPI.
            </p>
            <form id="withdraw-form">
                <div class="mb-4">
                    <label for="withdraw-amount-input" class="block text-gray-300 text-sm font-semibold mb-2">Amount (₹):</label>
                    <input type="number" id="withdraw-amount-input" class="w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600" placeholder="e.g., 150" min="100" step="any" required />
                </div>
                <div class="mb-6">
                    <label for="upi-id-input" class="block text-gray-300 text-sm font-semibold mb-2">Your UPI ID:</label>
                    <input type="text" id="upi-id-input" class="w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600" placeholder="e.g., yourname@upi" required />
                </div>
                <p id="withdraw-error-message" class="text-red-500 text-sm mb-4 hidden"></p>
                <button type="submit" id="withdraw-submit-button" class="w-full py-3 bg-green-600 hover:bg-green-700 rounded-md font-bold text-white transition duration-200 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="withdraw-button-text">Request Withdrawal</span>
                    <svg id="withdraw-loading-spinner" class="animate-spin h-5 w-5 ml-3 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <!-- Authentication Modal Structure -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[1100] p-4 hidden">
        <div class="modal-content p-8 w-full max-w-md text-center">
            <h2 id="auth-modal-title" class="text-2xl font-bold text-orange-400 mb-6">Login / Sign Up</h2>

            <div class="flex justify-center mb-6 rounded-lg overflow-hidden">
                <button id="auth-tab-login" class="flex-1 px-6 py-3 font-semibold transition duration-200 bg-orange-500 text-white">Login</button>
                <button id="auth-tab-signup" class="flex-1 px-6 py-3 font-semibold transition duration-200 bg-gray-700 text-gray-300 hover:bg-gray-600">Sign Up</button>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" class="w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600" placeholder="Email" required />
                <input type="password" id="login-password" class="w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600" placeholder="Password" required />
                <p id="login-error-message" class="text-red-500 text-sm hidden"></p>
                <button type="submit" id="login-submit-button" class="w-full py-3 btn-primary rounded-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="login-button-text">Login</span>
                    <svg id="login-loading-spinner" class="animate-spin h-5 w-5 ml-3 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
                <button type="button" id="forgot-password-button" class="text-gray-400 hover:text-orange-400 text-sm mt-2 transition-colors duration-200">Forgot Password?</button>
            </form>

            <!-- Sign Up Form -->
            <form id="signup-form" class="space-y-4 hidden">
                <input type="email" id="signup-email" class="w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600" placeholder="Email" required />
                <input type="password" id="signup-password" class="w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600" placeholder="Password (min 6 characters)" required />
                <p id="signup-error-message" class="text-red-500 text-sm hidden"></p>
                <button type="submit" id="signup-submit-button" class="w-full py-3 btn-primary rounded-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="signup-button-text">Sign Up</span>
                    <svg id="signup-loading-spinner" class="animate-spin h-5 w-5 ml-3 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </form>

            <div class="relative flex items-center justify-center my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-700"></div>
                </div>
                <div class="relative z-10 px-4 bg-gray-800 text-gray-400 text-sm">OR</div>
            </div>

            <button id="google-sign-in-button" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md transition duration-200 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.0001 4.54518C14.1561 4.54518 15.9321 5.26718 17.2791 6.55418L20.0241 3.80918C18.1081 1.86818 15.2891 0.72718 12.0001 0.72718C7.68313 0.72718 4.02013 3.03718 2.05413 6.44418L6.08213 9.47918C6.96713 7.21818 9.38713 5.45418 12.0001 5.45418V4.54518ZM23.0901 12.0002C23.0901 11.2332 23.0231 10.4792 22.8981 9.73918H12.0001V14.2612H18.4141C18.1751 15.6362 17.3871 16.7902 16.2051 17.5842L20.2331 20.6192C22.2001 17.1852 23.0901 13.9162 23.0901 12.0002Z" fill="#4285F4"/>
                    <path d="M12.0001 23.2732C15.2891 23.2732 18.1081 22.1322 20.0241 20.1912L17.2791 17.4462C15.9321 18.7332 14.1561 19.4552 12.0001 19.4552C9.38713 19.4552 6.96713 17.6912 6.08213 15.4302L2.05413 18.4652C4.02013 21.8722 7.68313 23.2732 12.0001 23.2732Z" fill="#34A853"/>
                    <path d="M4.05404 15.4302L0.0259998 18.4652C0.603003 19.4202 1.34304 20.2792 2.22804 20.9702L6.25604 17.9352C5.37104 17.2442 4.63104 16.3852 4.05404 15.4302Z" fill="#F9BC05"/>
                    <path d="M2.05404 6.44418L6.08204 9.47918C6.96704 7.21818 9.38704 5.45418 12.0001 5.45418V0.72718C7.68313 0.72718 4.02013 3.03718 2.05404 6.44418Z" fill="#EA4335"/>
                </svg>
                <span>Sign in with Google</span>
            </button>

            <button id="guest-login-button" class="w-full py-3 btn-secondary rounded-md mt-4 disabled:opacity-50 disabled:cursor-not-allowed">
                <span id="guest-login-button-text">Continue as Guest</span>
                <svg id="guest-login-loading-spinner" class="animate-spin h-5 w-5 ml-3 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            signOut,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            sendEmailVerification,
            GoogleAuthProvider,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables ---
        let app;
        let db;
        let auth;
        let currentUserId = null;
        let authReady = false; // Flag to indicate if Firebase auth is initialized
        let currentPage = 'home'; // 'home', 'profile', 'search', 'people', 'shorts'
        let currentVideoIdForComments = null;
        let profileVideoTypeFilter = 'long'; // For profile page: 'long' or 'short'
        let allVideosCache = []; // Cache for search functionality

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDes3ioeygnWBqJB6NnHb7xj732JJhOqm8",
            authDomain: "videofire-268ff.firebaseapp.com",
            databaseURL: "https://videofire-268ff-default-rtdb.firebaseio.com",
            projectId: "videofire-268ff",
            storageBucket: "videofire-268ff.firebasestorage.app",
            messagingSenderId: "910374058927",
            appId: "1:910374058927:web:6add3afdea07cfa2914d5a"
        };

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // VAST Ad Tag URL - Using a Google sample ad pod tag that should provide skippable ads.
        // This tag generally provides 2 linear ads in a pod.
        // The skip button and its timing are controlled by the ad server and Google IMA SDK, not directly by the app.
        const vastAdTagUrl = "https://pubads.g.doubleclick.net/gampad/ads?sz=640x480&iu=/124319096/external/ad_rule_samples&ciu_szs=300x250&ad_rule=1&gdfp_req=1&env=vp&output=vast&unviewed_position_start=1&cust_params=deployment%3Ddevsite%26sample_ar%3Dpremidpostpod&cmsid=496&vid=short_video&correlator=";

        // --- DOM Elements ---
        const homePage = document.getElementById('home-page');
        const profilePage = document.getElementById('profile-page');
        const searchPage = document.getElementById('search-page'); // Placeholder now but remains
        const peoplePage = document.getElementById('people-page'); // Placeholder now but remains
        const videoFeedContainer = document.getElementById('video-feed-container');

        const homeLoading = document.getElementById('home-loading');
        const homeError = document.getElementById('home-error');
        const noVideosMessage = document.getElementById('no-videos-message');

        const profileUsername = document.getElementById('profile-username');
        const profileUserId = document.getElementById('profile-user-id');
        const profileUploadsCount = document.getElementById('profile-uploads-count');
        const userVideosContainer = document.getElementById('user-videos-container');
        const noUserVideosMessage = document.getElementById('no-user-videos-message');
        const profileLoading = document.getElementById('profile-loading');
        const profileError = document.getElementById('profile-error');
        const profileTabVideos = document.getElementById('profile-tab-videos');
        const profileTabShorts = document.getElementById('profile-tab-shorts');

        const customModal = document.getElementById('custom-modal');
        const customModalTitle = document.getElementById('custom-modal-title');
        const customModalMessage = document.getElementById('custom-modal-message');
        const customModalConfirmButton = document.getElementById('custom-modal-confirm-button');
        const customModalCloseButton = document.getElementById('custom-modal-close-button');

        const commentModal = document.getElementById('comment-modal');
        const commentModalCloseButton = document.getElementById('comment-modal-close-button');
        const commentList = document.getElementById('comment-list');
        const commentLoading = document.getElementById('comment-loading');
        const noCommentsMessage = document.getElementById('no-comments-message');
        const newCommentInput = document.getElementById('new-comment-input');
        const addCommentButton = document.getElementById('add-comment-button');

        const uploadVideoModal = document.getElementById('upload-video-modal');
        const uploadModalCloseButton = document.getElementById('upload-modal-close-button');
        const uploadVideoForm = document.getElementById('upload-video-form');
        const videoUrlInput = document.getElementById('video-url-input');
        const videoTitleInput = document.getElementById('video-title-input');
        const videoDescriptionInput = document.getElementById('video-description-input');
        const videoTagsInput = document.getElementById('video-tags-input');
        const videoVisibilityPublic = document.querySelector('input[name="video-visibility"][value="public"]');
        const videoVisibilityPrivate = document.querySelector('input[name="video-visibility"][value="private"]');
        const videoTypeLong = document.querySelector('input[name="video-type"][value="long"]');
        const videoTypeShort = document.querySelector('input[name="video-type"][value="short"]');
        const monetizeVast = document.getElementById('monetize-vast');
        const monetizeBanner468x60 = document.getElementById('monetize-banner-468x60');
        const monetizeBanner300x250 = document.getElementById('monetize-banner-300x250');
        const monetizeNative = document.getElementById('monetize-native');
        const uploadErrorMessage = document.getElementById('upload-error-message');
        const uploadSubmitButton = document.getElementById('upload-submit-button');
        const uploadButtonText = document.getElementById('upload-button-text');
        const uploadLoadingSpinner = document.getElementById('upload-loading-spinner');

        const withdrawModal = document.getElementById('withdraw-modal');
        const withdrawModalCloseButton = document.getElementById('withdraw-modal-close-button');
        const withdrawForm = document.getElementById('withdraw-form');
        const withdrawAmountInput = document.getElementById('withdraw-amount-input');
        const upiIdInput = document.getElementById('upi-id-input');
        const withdrawErrorMessage = document.getElementById('withdraw-error-message');
        const withdrawSubmitButton = document.getElementById('withdraw-submit-button');
        const withdrawButtonText = document.getElementById('withdraw-button-text');
        const withdrawLoadingSpinner = document.getElementById('withdraw-loading-spinner');

        const imaAdContainer = document.getElementById('ima-ad-container'); // Global IMA ad container

        const displayUserId = document.getElementById('display-user-id');
        const userInfo = document.getElementById('user-info');
        const signOutButton = document.getElementById('sign-out-button');

        // Auth Modal Elements
        const authModal = document.getElementById('auth-modal');
        const authTabLogin = document.getElementById('auth-tab-login');
        const authTabSignup = document.getElementById('auth-tab-signup');

        const loginForm = document.getElementById('login-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginErrorMessage = document.getElementById('login-error-message');
        const loginSubmitButton = document.getElementById('login-submit-button');
        const loginButtonText = document.getElementById('login-button-text');
        const loginLoadingSpinner = document.getElementById('login-loading-spinner');
        const forgotPasswordButton = document.getElementById('forgot-password-button');

        const signupForm = document.getElementById('signup-form');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupErrorMessage = document.getElementById('signup-error-message');
        const signupSubmitButton = document.getElementById('signup-submit-button');
        const signupButtonText = document.getElementById('signup-button-text');
        const signupLoadingSpinner = document.getElementById('signup-loading-spinner');

        const googleSignInButton = document.getElementById('google-sign-in-button');
        const guestLoginButton = document.getElementById('guest-login-button');
        const guestLoginButtonText = document.getElementById('guest-login-button-text');
        const guestLoginLoadingSpinner = document.getElementById('guest-login-loading-spinner');

        // Header Search Elements
        const headerSearchContainer = document.getElementById('header-search-container');
        const headerSearchInput = document.getElementById('header-search-input');
        const headerButtonsContainer = document.getElementById('header-buttons-container');
        const clearSearchButton = document.getElementById('clear-search-button');


        // --- Utility Functions ---

        /**
         * Parses a YouTube URL to extract video ID, embed URL, and thumbnail URL.
         * @param {string} url - The YouTube video URL.
         * @returns {object|null} An object with videoId, embedUrl, thumbnailUrl, or null if invalid.
         */
        function getYouTubeInfo(url) {
            // Regex to capture video ID from various YouTube URL formats including shorts
            const regExp = /(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|shorts\/|v\/|)([\w-]{11})(?:\S+)?/g;
            const match = regExp.exec(url);

            if (match && match[1]) {
                const videoId = match[1];
                return {
                    videoId: videoId,
                    // Autoplay, no controls, modestbranding (no YouTube logo), no related videos, loop.
                    // For shorts, YouTube iframe automatically adjusts for vertical play.
                    embedUrl: `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=0&modestbranding=1&rel=0&loop=1&playlist=${videoId}`,
                    thumbnailUrl: `https://img.youtube.com/vi/${videoId}/hqdefault.jpg` // High quality thumbnail
                };
            }
            return null;
        }

        /**
         * Shows a custom modal dialog.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message content.
         * @param {boolean} showConfirmButton - Whether to show a confirm button.
         * @param {function} onConfirm - Callback for confirm button.
         * @param {function} onClose - Callback for close button.
         */
        function showCustomModal(title, message, showConfirmButton = false, onConfirm = () => {}, onClose = () => {}) {
            customModalTitle.innerHTML = title; // Use innerHTML to allow for HTML in message
            customModalMessage.innerHTML = message; // Use innerHTML to allow for HTML in message
            customModalConfirmButton.onclick = () => { onConfirm(); closeModal('custom'); };
            customModalCloseButton.onclick = () => { onClose(); closeModal('custom'); };

            if (showConfirmButton) {
                customModalConfirmButton.classList.remove('hidden');
            } else {
                customModalConfirmButton.classList.add('hidden');
            }
            customModal.classList.remove('hidden');
        }

        /**
         * Closes a specific modal.
         * @param {string} modalName - The name of the modal ('custom', 'comment', 'upload', 'withdraw', 'auth').
         */
        function closeModal(modalName) {
            switch (modalName) {
                case 'custom':
                    customModal.classList.add('hidden');
                    break;
                case 'comment':
                    commentModal.classList.add('hidden');
                    currentVideoIdForComments = null;
                    break;
                case 'upload':
                    uploadVideoModal.classList.add('hidden');
                    uploadVideoForm.reset(); // Clear form fields
                    // Reset default settings explicitly as form.reset() might not cover toggles/radios
                    videoUrlInput.value = '';
                    videoTitleInput.value = '';
                    videoDescriptionInput.value = '';
                    videoTagsInput.value = '';
                    videoVisibilityPublic.checked = true; // Default to public
                    videoTypeLong.checked = true; // Default to long video
                    monetizeVast.checked = true; // Default to checked
                    monetizeBanner468x60.checked = true;
                    monetizeBanner300x250.checked = true;
                    monetizeNative.checked = true;
                    uploadErrorMessage.classList.add('hidden');
                    break;
                case 'withdraw':
                    withdrawModal.classList.add('hidden');
                    withdrawForm.reset();
                    withdrawAmountInput.value = '';
                    upiIdInput.value = '';
                    withdrawErrorMessage.classList.add('hidden');
                    break;
                case 'auth':
                    authModal.classList.add('hidden');
                    loginForm.reset();
                    signupForm.reset();
                    loginErrorMessage.classList.add('hidden');
                    signupErrorMessage.classList.add('hidden');
                    break;
            }
        }


        // --- Firebase Initialization ---

        /**
         * Initializes Firebase and sets up authentication listener.
         */
        async function initializeFirebase() {
            console.log("Initializing Firebase...");
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase app, db, auth initialized.");

                // Auth state listener
                onAuthStateChanged(auth, async (user) => {
                    console.log("Auth state changed. User:", user ? user.uid : "No user");
                    if (user) {
                        currentUserId = user.uid;
                        // Display username or a truncated UID
                        const userProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/${user.uid}`);
                        const userDoc = await getDoc(userProfileRef);
                        const displayUsername = userDoc.exists() && userDoc.data().username ? userDoc.data().username : user.email ? user.email.split('@')[0] : currentUserId.substring(0, 8) + '...';
                        displayUserId.textContent = displayUsername;

                        userInfo.classList.remove('hidden'); // Show user info
                        closeModal('auth'); // Close auth modal if user logs in

                        // Ensure user profile exists (or create a dummy one)
                        try {
                            if (!userDoc.exists()) {
                                console.log("Creating new user profile for UID:", user.uid);
                                await setDoc(userProfileRef, {
                                    username: user.email ? user.email.split('@')[0] : `User_${user.uid.substring(0, 6)}`,
                                    email: user.email || null,
                                    joinedAt: serverTimestamp(),
                                    isEmailVerified: user.emailVerified || false,
                                    followers: [],
                                    following: []
                                });
                            } else {
                                // Update profile with latest info if email is verified
                                const userData = userDoc.data();
                                if (user.emailVerified && !userData.isEmailVerified) {
                                    await updateDoc(userProfileRef, { isEmailVerified: true });
                                }
                                // Ensure new fields exist for existing users (for backward compatibility)
                                if (!userData.followers) await updateDoc(userProfileRef, { followers: [] });
                                if (!userData.following) await updateDoc(userProfileRef, { following: [] });
                            }
                        } catch (profileError) {
                            console.error("Error creating/fetching user profile:", profileError);
                            showCustomModal('Profile Error', 'Failed to load user profile. Some features might be limited.', false);
                        }

                    } else {
                        currentUserId = null;
                        displayUserId.textContent = '';
                        userInfo.classList.add('hidden'); // Hide user info
                        authModal.classList.remove('hidden'); // Show auth modal if no user is logged in
                    }
                    authReady = true; // Firebase auth has completed its initial check
                    console.log("Auth is ready. Current page:", currentPage);
                    // Only show page if auth is ready and user is logged in (or explicitly a guest)
                    if (user || initialAuthToken) { // If user is logged in or custom token was attempted
                        showPage(currentPage);
                    } else if (!user && !authModal.classList.contains('hidden')) {
                         // If no user and auth modal is shown, do nothing (wait for user action)
                         homeLoading.classList.add('hidden'); // Hide loading if auth modal is shown
                    }
                });

                // Use the initialAuthToken if available
                if (initialAuthToken) {
                    try {
                        console.log("Signing in with custom token...");
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token successfully.");
                    } catch (error) {
                        console.error("Error signing in with custom token:", error);
                        // The onAuthStateChanged listener will handle the case of no user after this attempt.
                    }
                }

                console.log("Firebase initialized.");

            } catch (error) {
                console.error("Critical: Failed to initialize Firebase:", error);
                showCustomModal('Initialization Error', 'Failed to initialize the application. Please check console for details and ensure your Firebase config is correct.', false);
                authReady = false;
                // Display a full-screen error message
                homeLoading.classList.add('hidden');
                homeError.textContent = `Critical error initializing app: ${error.message}. Please check your Firebase configuration.`;
                homeError.classList.remove('hidden');
                homePage.classList.remove('hidden'); // Ensure home page is visible to show error
                profilePage.classList.add('hidden'); // Hide other pages
            }
        }


        // --- UI Navigation and Rendering ---

        /**
         * Shows the specified page and hides others.
         * @param {string} pageName - The name of the page to show ('home', 'profile', 'search', 'people', 'shorts').
         * @param {string} [videoType='long'] - Optional: video type to load for home/shorts feeds.
         */
        function showPage(pageName, videoType = 'long') {
            currentPage = pageName;
            const pages = [homePage, profilePage, searchPage, peoplePage];
            const footerButtons = {
                'home': document.getElementById('home-footer-button'),
                'shorts': document.getElementById('shorts-footer-button'),
                'upload': document.getElementById('upload-footer-button'),
                'people': document.getElementById('people-footer-button'),
                'profile': document.getElementById('profile-footer-button')
            };

            pages.forEach(page => page.classList.add('hidden'));

            // Reset footer button styles
            Object.values(footerButtons).forEach(btn => {
                if(btn) {
                    btn.classList.remove('footer-btn-active');
                    btn.classList.add('text-gray-400', 'hover:bg-gray-700');
                }
            });

            // Handle header elements visibility based on page
            // Search bar only shows in header when on 'search' page OR when the search icon is explicitly clicked
            if (pageName === 'search' || headerSearchContainer.classList.contains('active')) { // 'active' class used for manual toggle
                headerSearchContainer.classList.remove('hidden');
                headerButtonsContainer.classList.add('hidden');
                headerSearchInput.focus();
            } else {
                headerSearchContainer.classList.add('hidden');
                headerButtonsContainer.classList.remove('hidden');
                headerSearchInput.value = ''; // Clear search on navigation away
                headerSearchContainer.classList.remove('active'); // Remove active state
            }


            if (!authReady || !currentUserId) {
                console.log("Auth not ready or user not logged in, showing auth modal.");
                authModal.classList.remove('hidden');
                homeLoading.classList.add('hidden');
                return;
            }

            // Set active state for the current footer button
            const activeFooterButton = footerButtons[pageName === 'shorts' ? 'shorts' : pageName];
            if (activeFooterButton) {
                activeFooterButton.classList.add('footer-btn-active');
                activeFooterButton.classList.remove('text-gray-400', 'hover:bg-gray-700');
            }


            switch (pageName) {
                case 'home':
                    homePage.classList.remove('hidden');
                    homePage.classList.remove('shorts-mode'); // Ensure shorts-mode is off
                    updateVideoFeed('long'); // Load long videos for home feed
                    break;
                case 'shorts':
                    homePage.classList.remove('hidden'); // Shorts also use homePage container
                    homePage.classList.add('shorts-mode'); // Add shorts-mode class
                    updateVideoFeed('short'); // Load short videos for shorts feed
                    break;
                case 'profile':
                    profilePage.classList.remove('hidden');
                    updateProfilePage(profileVideoTypeFilter); // Use the stored filter
                    break;
                case 'search':
                    searchPage.classList.remove('hidden');
                    // Search is now handled directly by header search bar and updateVideoFeed
                    // The content for searchPage remains a placeholder.
                    break;
                case 'people':
                    peoplePage.classList.remove('hidden');
                    break;
                default:
                    homePage.classList.remove('hidden'); // Fallback to home
                    homePage.classList.remove('shorts-mode');
                    updateVideoFeed('long');
                    break;
            }
        }

        /**
         * Updates the video feed on the home page based on video type and optional search query.
         * @param {string} videoType - 'long' or 'short'.
         * @param {string} [searchQuery=''] - Optional search query.
         */
        async function updateVideoFeed(videoType = 'long', searchQuery = '') {
            if (!authReady || !db) {
                console.warn("Firebase not ready for video feed. Aborting updateVideoFeed.");
                homeLoading.classList.add('hidden');
                homeError.textContent = "App not ready. Please wait or refresh.";
                homeError.classList.remove('hidden');
                return;
            }

            homeLoading.classList.remove('hidden');
            homeError.classList.add('hidden');
            noVideosMessage.classList.add('hidden');
            videoFeedContainer.innerHTML = ''; // Clear previous videos

            console.log(`Fetching ${videoType} videos from Firestore with search query: "${searchQuery}"`);
            try {
                const videosColRef = collection(db, `artifacts/${appId}/public/data/videos`);
                const q = query(videosColRef, where('videoType', '==', videoType));

                onSnapshot(q, async (snapshot) => {
                    let videoList = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    // Client-side sort by timestamp (descending)
                    videoList.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

                    // Filter videos based on visibility: only public videos from others, or private videos if current user is uploader
                    let filteredVideoList = videoList.filter(video => {
                        if (video.visibility === 'private') {
                            return video.userId === currentUserId; // Only uploader can see their private videos
                        }
                        return true; // Public videos are visible to everyone
                    });

                    // Apply search filter if query exists
                    if (searchQuery) {
                        const lowerCaseQuery = searchQuery.toLowerCase();
                        filteredVideoList = filteredVideoList.filter(video =>
                            (video.title && video.title.toLowerCase().includes(lowerCaseQuery)) ||
                            (video.description && video.description.toLowerCase().includes(lowerCaseQuery)) ||
                            (video.userName && video.userName.toLowerCase().includes(lowerCaseQuery)) ||
                            (video.tags && video.tags.some(tag => tag.toLowerCase().includes(lowerCaseQuery)))
                        );
                    }
                    allVideosCache = filteredVideoList; // Update cache for search bar

                    console.log(`Fetched and filtered ${videoType} videos:`, filteredVideoList);

                    if (filteredVideoList.length === 0) {
                        noVideosMessage.classList.remove('hidden');
                        homeLoading.classList.add('hidden');
                        return;
                    }

                    // For Shorts, adjust container classes for vertical layout
                    if (videoType === 'short') {
                        videoFeedContainer.classList.add('flex', 'flex-col', 'items-center', 'justify-center');
                        videoFeedContainer.classList.remove('grid', 'grid-cols-1'); // Remove grid if it was added
                    } else {
                        videoFeedContainer.classList.remove('flex', 'flex-col', 'items-center', 'justify-center');
                        // For long videos, we don't need grid here as each card takes full width in this layout
                    }

                    videoFeedContainer.innerHTML = ''; // Clear existing videos before re-rendering
                    for (let i = 0; i < filteredVideoList.length; i++) {
                        const video = filteredVideoList[i];
                        const videoCard = createVideoCardElement(video);
                        videoFeedContainer.appendChild(videoCard);

                        // Inject a banner ad after every N shorts videos IF monetization is ON for banner300x250
                        // This serves as the "in-feed" ad.
                        if (video.videoType === 'short' && video.monetization?.banner300x250 && (i + 1) % 3 === 0) { // Every 3 videos
                            const adDiv = document.createElement('div');
                            adDiv.className = 'w-[300px] h-[250px] bg-gray-800 rounded-md flex items-center justify-center text-xs text-gray-400 border border-gray-700 flex-shrink-0 snap-center my-4 text-center p-4';
                            adDiv.id = `shorts-banner-ad-${video.id}-${i}`;
                            adDiv.innerHTML = `<span class="block">Shorts In-Feed Ad</span><span class="block text-orange-400 mt-2 text-sm">Ad by definitive-priority.com</span>`;
                            videoFeedContainer.appendChild(adDiv);
                            injectSpecificAdScript(adDiv.id, 'banner300x250'); // Use 300x250 for in-feed
                        }
                    }
                    homeLoading.classList.add('hidden');
                    noVideosMessage.classList.add('hidden');

                }, (err) => {
                    console.error("Error in onSnapshot for videos:", err);
                    homeError.textContent = `Failed to load videos: ${err.message}. Check Firebase security rules.`;
                    homeError.classList.remove('hidden');
                    homeLoading.classList.add('hidden');
                });

            }
            catch (error) {
                console.error("Error setting up video feed listener:", error);
                homeError.textContent = `Error: ${error.message}. Could not set up real-time listener.`;
                homeError.classList.remove('hidden');
                homeLoading.classList.add('hidden');
            }
        }

        /**
         * Creates an HTML element for a single video card.
         * @param {object} video - The video data.
         * @returns {HTMLElement} The video card element.
         */
        function createVideoCardElement(video) {
            console.log("Creating video card for:", video.id, "Title:", video.title);
            const videoCard = document.createElement('div');
            videoCard.id = `video-card-${video.id}`;

            // Determine class based on video type for responsive layout
            videoCard.className = `video-card-item relative w-full ${video.videoType === 'short' ? 'h-full aspect-[9/16] max-w-[400px] mx-auto' : 'mb-8'} snap-center bg-gray-900 overflow-hidden border border-gray-800 shadow-xl`;
            if (video.videoType === 'long') {
                videoCard.style.paddingBottom = '56.25%'; /* 16:9 aspect ratio for long videos */
                videoCard.style.position = 'relative';
                videoCard.style.height = '0';
            }


            const youTubeInfo = getYouTubeInfo(video.youtubeUrl);
            const thumbnailUrl = youTubeInfo ? youTubeInfo.thumbnailUrl : 'https://placehold.co/1280x720/000000/FFFFFF?text=Invalid+Video+URL';

            // Format upload time
            const uploadTime = video.timestamp ? new Date(video.timestamp.toDate()).toLocaleString() : 'N/A';

            // Extract tags and format them
            const tagsHtml = (video.tags && video.tags.length > 0)
                ? video.tags.map(tag => `<span class="inline-block bg-gray-700 text-gray-300 rounded-full px-3 py-1 text-xs font-semibold mr-2 mb-2">#${tag.trim()}</span>`).join('')
                : '';

            videoCard.innerHTML = `
                <!-- Video Player Container (Thumbnail/Iframe) -->
                <div id="player-container-${video.id}" class="player-container relative w-full h-full bg-black flex items-center justify-center overflow-hidden">
                    <!-- Thumbnail placeholder -->
                    <img id="thumbnail-${video.id}" src="${thumbnailUrl}" alt="Video Thumbnail" class="absolute inset-0 w-full h-full object-cover z-10" />

                    <!-- Shorts Indicator -->
                    ${video.videoType === 'short' ? `<div class="short-indicator"><i class="fa-solid fa-bolt"></i> Shorts</div>` : ''}

                    <!-- Play button overlay on thumbnail -->
                    <button id="play-button-${video.id}" class="absolute z-20 bg-black bg-opacity-70 rounded-full p-4 hover:scale-110 transition-transform duration-200 focus:outline-none focus:ring-4 focus:ring-orange-500 focus:ring-opacity-50">
                        <svg class="h-10 w-10 text-orange-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                    </button>

                    <!-- Message after ad finishes (briefly) -->
                    <div id="ad-message-${video.id}" class="absolute top-4 left-1/2 -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded-full text-sm font-semibold animate-fade-in-out z-40 hidden">
                        Video playing soon!
                    </div>
                    <!-- Actual YouTube iframe will be dynamically added here -->
                    <div id="youtube-iframe-wrapper-${video.id}" class="w-full h-full hidden"></div>
                </div>

                <!-- Video Info and Controls Overlay -->
                <div class="video-info-overlay flex flex-col justify-end text-white z-10">
                    <h2 class="text-xl font-bold mb-1 text-orange-300 drop-shadow">${video.title}</h2>
                    <p class="text-sm text-gray-300 mb-2 drop-shadow">${video.description || ''}</p>
                    <div class="flex flex-wrap mb-2">${tagsHtml}</div>
                    <p class="text-sm text-gray-300 mb-4 drop-shadow">By ${video.userName || 'Anonymous User'} | ${video.viewsCount || 0} views | Uploaded: ${uploadTime}</p>

                    <!-- Social Buttons -->
                    <div class="flex items-center space-x-6 text-xl">
                        <button id="like-button-${video.id}" class="flex items-center space-x-1 p-2 rounded-full hover:bg-gray-700 transition duration-200">
                            <svg class="h-6 w-6 text-gray-300 like-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                            </svg>
                            <span class="text-sm like-count">${video.likesCount || 0}</span>
                        </button>
                        <button id="comment-button-${video.id}" class="flex items-center space-x-1 p-2 rounded-full hover:bg-gray-700 transition duration-200">
                            <svg class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            <span class="text-sm">Comments</span>
                        </button>
                        <button class="flex items-center space-x-1 p-2 rounded-full hover:bg-gray-700 transition duration-200" onclick="shareVideo('${video.id}', '${video.title}', '${video.youtubeUrl}')">
                            <svg class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.516 3.832a3 3 0 00.512-1.632V12c0-.36-.062-.716-.184-1.049m0 2.098L8.684 10.658m10.158-1.342a3 3 0 110-2.684m0 2.684l-6.516-3.832a3 3 0 00-.512 1.632V12c0 .36.062.716.184 1.049m0-2.098L18.842 8.658"></path>
                            </svg>
                            <span class="text-sm">Share</span>
                        </button>
                    </div>

                    <!-- Conditional Ads (banners below video details) -->
                    ${video.monetization?.banner468x60 ? `<div class="mt-4 w-full flex justify-center">
                        <div id="adstreaa-banner-468x60-${video.id}" class="w-[468px] h-[60px] bg-gray-800 rounded-md flex items-center justify-center text-xs text-gray-400 border border-gray-700 text-center p-2">
                             Banner 468x60 Ad <br> (by HighPerformanceFormat.com)
                        </div>
                    </div>` : ''}

                    ${video.monetization?.native ? `<div class="mt-4 w-full flex justify-center">
                        <div id="adstreaa-native-${video.id}" class="w-full max-w-sm bg-gray-800 rounded-md flex items-center justify-center text-xs text-gray-400 border border-gray-700 p-2 min-h-[100px] text-center">
                            Native Ad <br> (Content will load if configured by ad network)
                        </div>
                    </div>` : ''}
                </div>
            `;

            // Attach event listeners after element is in DOM
            const playButton = videoCard.querySelector(`#play-button-${video.id}`);
            if (playButton) {
                playButton.addEventListener('click', () => {
                    const playerContainer = videoCard.querySelector(`#player-container-${video.id}`);
                    const thumbnail = videoCard.querySelector(`#thumbnail-${video.id}`);
                    const youtubeIframeWrapper = videoCard.querySelector(`#youtube-iframe-wrapper-${video.id}`);
                    const adMessage = videoCard.querySelector(`#ad-message-${video.id}`);

                    // Hide play button after click
                    playButton.classList.add('hidden');

                    // If VAST ads are enabled for this video, play ad first
                    if (video.monetization?.vast) {
                        playVideoWithAd(video, playerContainer, thumbnail, youtubeIframeWrapper, adMessage);
                    } else {
                        console.log("VAST ads disabled for video:", video.id, ". Playing video directly.");
                        cleanupAdAndShowVideo(video, playerContainer, thumbnail, youtubeIframeWrapper, adMessage, true); // Skip ad
                    }
                });
            }

            videoCard.querySelector(`#like-button-${video.id}`).addEventListener('click', () => handleLike(video.id));
            videoCard.querySelector(`#comment-button-${video.id}`).addEventListener('click', () => openCommentModal(video.id));

            // Set up real-time like count listener
            const likeCountSpan = videoCard.querySelector(`#like-button-${video.id} .like-count`);
            const likeIcon = videoCard.querySelector(`#like-button-${video.id} .like-icon`);
            const videoRef = doc(db, `artifacts/${appId}/public/data/videos/${video.id}`);
            onSnapshot(videoRef, (docSnap) => {
                if (docSnap.exists()) {
                    const currentLikes = docSnap.data().likesCount || 0;
                    likeCountSpan.textContent = currentLikes;
                }
            });

            // Check initial like status
            if (currentUserId && db) { // Ensure db is available
                const userLikeRef = doc(db, `artifacts/${appId}/public/data/likes/${video.id}_${currentUserId}`);
                getDoc(userLikeRef).then(docSnap => {
                    if (docSnap.exists()) {
                        likeIcon.classList.remove('text-gray-300');
                        likeIcon.classList.add('text-red-500', 'fill-current');
                        // Replace SVG path for filled heart
                        likeIcon.innerHTML = '<path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78L12 21.23l8.84-8.64a5.5 5.5 0 000-7.78z" fill="currentColor"></path>';
                    }
                }).catch(error => console.error("Error checking initial like status:", error));
            }

            // Inject specific ad scripts into their respective containers conditionally
            if (video.monetization?.banner468x60) {
                injectSpecificAdScript(`adstreaa-banner-468x60-${video.id}`, 'banner468x60');
            }
            // For shorts in-feed ads, the script is injected in updateVideoFeed.
            // For long videos, this is a banner below the video details.
            if (video.monetization?.banner300x250 && video.videoType === 'long') {
                injectSpecificAdScript(`adstreaa-banner-300x250-${video.id}`, 'banner300x250');
            }
            if (video.monetization?.native) {
                injectSpecificAdScript(`adstreaa-native-${video.id}`, 'native');
            }

            return videoCard;
        }

        /**
         * Injects ad scripts into specific div IDs.
         * This is a utility to encapsulate ad script loading.
         * @param {string} divId The ID of the div where the ad should be injected.
         * @param {string} adType The type of ad ('banner468x60', 'banner300x250', 'native').
         */
        function injectSpecificAdScript(divId, adType) {
            const adDiv = document.getElementById(divId);
            if (!adDiv) {
                console.warn(`Ad div with ID ${divId} not found.`);
                return;
            }

            // Clear existing content to prevent duplicate ad loads on re-render
            adDiv.innerHTML = ''; // Clear placeholder text

            if (adType === 'banner468x60') {
                const script1 = document.createElement('script');
                script1.type = 'text/javascript';
                script1.textContent = `
                    var atOptions = {
                        'key' : '7281653bd62d5d460d6daa8793f19c5e',
                        'format' : 'iframe',
                        'height' : 60,
                        'width' : 468,
                        'params' : {}
                    };
                    document.write('<scr' + 'ipt type="text/javascript" src="//www.highperformanceformat.com/7281653bd62d5d460d6daa8793f19c5e/invoke.js"></scr' + 'ipt>');
                `;
                adDiv.appendChild(script1);

            } else if (adType === 'banner300x250') {
                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.textContent = `
                    (function(zrot){
                        var d = document,
                        s = d.createElement('script'),
                        l = d.scripts[d.scripts.length - 1];
                        s.settings = zrot || {};
                        s.src = "//definitive-priority.com/bOX/VYsBd.Golu0eYpWdco/reFmA9WujZeU/lTkBPQTiYH0IMrj_Q_1BNsjJI-tTNujcQ/yrNSDxU/2SMowA";
                        s.async = true;
                        s.referrerPolicy = 'no-referrer-when-downgrade';
                        l.parentNode.insertBefore(s, l);
                    })({});
                `;
                adDiv.appendChild(script);
            } else if (adType === 'native') {
                // For native ads, the specific ad network's setup would go here.
                // This is a placeholder.
                adDiv.textContent = "Native Ad (Content will load if configured by ad network)";
            }
        }


        /**
         * Updates the profile page with user-specific data and filters videos by type.
         * @param {string} videoTypeFilter - 'long' or 'short' to filter user's uploads.
         */
        async function updateProfilePage(videoTypeFilter = 'long') {
            profileVideoTypeFilter = videoTypeFilter; // Store the current filter for future updates

            if (!authReady || !db || !currentUserId) {
                console.warn("Firebase or user not ready for profile page. Aborting updateProfilePage.");
                profileLoading.classList.add('hidden');
                profileError.textContent = "Please sign in to view your profile.";
                profileError.classList.remove('hidden');
                return;
            }

            profileLoading.classList.remove('hidden');
            profileError.classList.add('hidden');
            noUserVideosMessage.classList.add('hidden');
            userVideosContainer.innerHTML = ''; // Clear previous videos

            console.log("Updating profile page for user:", currentUserId);
            try {
                // Fetch user details
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/${currentUserId}`);
                const userDoc = await getDoc(userProfileRef);
                const username = userDoc.exists() ? userDoc.data().username : `User: ${currentUserId.substring(0, 8)}...`;
                profileUsername.textContent = username;
                profileUserId.textContent = currentUserId;
                document.getElementById('profile-avatar').src = `https://placehold.co/100x100/374151/E5E7EB?text=${username.charAt(0)}`;

                // Update tab active state
                if (profileVideoTypeFilter === 'long') {
                    profileTabVideos.classList.add('border-orange-500', 'text-orange-500');
                    profileTabVideos.classList.remove('border-transparent', 'text-gray-400', 'hover:text-white', 'hover:border-gray-500');
                    profileTabShorts.classList.remove('border-orange-500', 'text-orange-500');
                    profileTabShorts.classList.add('border-transparent', 'text-gray-400', 'hover:text-white', 'hover:border-gray-500');
                } else {
                    profileTabShorts.classList.add('border-orange-500', 'text-orange-500');
                    profileTabShorts.classList.remove('border-transparent', 'text-gray-400', 'hover:text-white', 'hover:border-gray-500');
                    profileTabVideos.classList.remove('border-orange-500', 'text-orange-500');
                    profileTabVideos.classList.add('border-transparent', 'text-gray-400', 'hover:text-white', 'hover:border-gray-500');
                }


                // Fetch videos uploaded by this user, filtered by videoType
                const videosColRef = collection(db, `artifacts/${appId}/public/data/videos`);
                const q = query(videosColRef, where('userId', '==', currentUserId), where('videoType', '==', profileVideoTypeFilter));

                onSnapshot(q, (snapshot) => {
                    let userVideos = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    // Client-side sort by timestamp (descending)
                    userVideos.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

                    profileUploadsCount.textContent = userVideos.length;
                    userVideosContainer.innerHTML = ''; // Clear previous

                    if (userVideos.length === 0) {
                        noUserVideosMessage.classList.remove('hidden');
                    } else {
                        noUserVideosMessage.classList.add('hidden');
                        userVideos.forEach(video => {
                            const youTubeInfo = getYouTubeInfo(video.youtubeUrl);
                            const thumbnailUrl = youTubeInfo ? youTubeInfo.thumbnailUrl : 'https://placehold.co/480x360/000/FFF?text=Video+Thumbnail';
                            const videoElement = `
                                <div class="bg-gray-900 rounded-lg overflow-hidden shadow-md border border-gray-800 transform hover:scale-105 transition-transform duration-200 cursor-pointer">
                                    <img src="${thumbnailUrl}" alt="${video.title}" class="w-full h-48 object-cover" />
                                    <div class="p-4">
                                        <h3 class="text-lg font-semibold text-orange-300 truncate">${video.title}</h3>
                                        <p class="text-sm text-gray-400 mt-1">${video.viewsCount || 0} views</p>
                                        <p class="text-xs text-gray-500 mt-1">Visibility: ${video.visibility || 'Public'}</p>
                                        ${video.videoType === 'short' ? '<span class="inline-block bg-purple-600 text-white text-xs px-2 py-1 rounded-full mt-1">Short</span>' : ''}
                                    </div>
                                </div>
                            `;
                            userVideosContainer.insertAdjacentHTML('beforeend', videoElement);
                        });
                    }
                    profileLoading.classList.add('hidden');
                }, (err) => {
                    console.error("Error in onSnapshot for user videos:", err);
                    profileError.textContent = `Failed to load user videos: ${err.message}. Check Firebase security rules.`;
                    profileError.classList.remove('hidden');
                    profileLoading.classList.add('hidden');
                });

            } catch (error) {
                console.error("Error updating profile page:", error);
                profileError.textContent = `Error: ${error.message}`;
                profileError.classList.remove('hidden');
                profileLoading.classList.add('hidden');
            }
        }


        // --- VAST Ad Integration Logic (Google IMA SDK) ---

        let currentAdManager = null;
        let isAdPlaying = false; // Global flag to indicate if an ad is currently playing

        /**
         * Plays a VAST ad using Google IMA SDK before showing the video.
         * @param {object} video - The video data.
         * @param {HTMLElement} playerContainer - The main container for video/ad (within the card).
         * @param {HTMLElement} thumbnail - The thumbnail element.
         * @param {HTMLElement} youtubeIframeWrapper - The wrapper for the YouTube iframe.
         * @param {HTMLElement} adMessageElement - The element to show message after ad.
         */
        function playVideoWithAd(video, playerContainer, thumbnail, youtubeIframeWrapper, adMessageElement) {
            console.log("Attempting to play ad for video:", video.id);

            // Ensure IMA SDK is loaded
            if (typeof google === 'undefined' || !google.ima) {
                console.error("Google IMA SDK not loaded. Skipping ad, playing video directly.");
                showCustomModal('Ad Error', 'Ad service not available. Playing video directly.', false);
                cleanupAdAndShowVideo(video, playerContainer, thumbnail, youtubeIframeWrapper, adMessageElement, true);
                return;
            }

            // Ensure any previous ad manager is destroyed
            if (currentAdManager) {
                currentAdManager.destroy();
                currentAdManager = null;
            }

            // Show global IMA ad container, covering the entire display for ad playback
            imaAdContainer.style.display = 'flex';
            // We need to hide the main content area so that the global ad container covers everything.
            document.querySelector('main').classList.add('hidden');
            
            isAdPlaying = true;
            thumbnail.classList.add('hidden'); // Hide thumbnail once play button is clicked and ad starts
            youtubeIframeWrapper.classList.add('hidden');
            adMessageElement.classList.add('hidden');


            const adDisplayContainer = new google.ima.AdDisplayContainer(imaAdContainer);
            const adsLoader = new google.ima.AdsLoader(adDisplayContainer);

            // Listen for ad errors
            adsLoader.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR, (adErrorEvent) => {
                console.error("Ad error from adsLoader:", adErrorEvent.getError().getMessage());
                showCustomModal('Ad Playback Error', 'Failed to play ad. Continuing to video.', false);
                cleanupAdAndShowVideo(video, playerContainer, thumbnail, youtubeIframeWrapper, adMessageElement, true); // True to skip ad
            }, false);

            // Listen for ads loaded event
            adsLoader.addEventListener(google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED, (adsManagerLoadedEvent) => {
                console.log("AdsManager Loaded event fired.");
                const adsManager = adsManagerLoadedEvent.getAdsManager();
                currentAdManager = adsManager;

                // Add event listeners for the AdsManager itself
                adsManager.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR, (adErrorEvent) => {
                    console.error("Ad manager error:", adErrorEvent.getError().getMessage());
                    cleanupAdAndShowVideo(video, playerContainer, thumbnail, youtubeIframeWrapper, adMessageElement, true); // True to skip ad
                }, false);

                adsManager.addEventListener(google.ima.AdEvent.Type.ALL_ADS_COMPLETED, () => {
                    console.log("VAST ad completed.");
                    cleanupAdAndShowVideo(video, playerContainer, thumbnail, youtubeIframeWrapper, adMessageElement, false); // False to indicate ad completed
                }, false);

                adsManager.addEventListener(google.ima.AdEvent.Type.LOADED, () => {
                    console.log("Ad LOADED event (before start)");
                }, false);

                adsManager.addEventListener(google.ima.AdEvent.Type.AD_BREAK_READY, () => {
                    console.log("Ad break ready. Starting ad playback.");
                }, false);

                adsManager.addEventListener(google.ima.AdEvent.Type.AD_SKIPPED, () => {
                    console.log("Ad SKIPPED event. Proceeding to video.");
                    cleanupAdAndShowVideo(video, playerContainer, thumbnail, youtubeIframeWrapper, adMessageElement, false); // Ad was skipped, proceed
                }, false);


                try {
                    // This initializes the AdsManager with the dimensions of the IMA ad container.
                    adsManager.init(imaAdContainer.offsetWidth, imaAdContainer.offsetHeight, google.ima.ViewMode.NORMAL);
                    adsManager.start(); // Start ad playback
                    console.log("VAST ad playback initiated.");
                } catch (adError) {
                    console.error("AdsManager could not be started:", adError);
                    cleanupAdAndShowVideo(video, playerContainer, thumbnail, youtubeIframeWrapper, adMessageElement, true); // True to skip ad
                }
            }, false);

            // Request ads
            const adsRequest = new google.ima.AdsRequest();
            adsRequest.adTagUrl = vastAdTagUrl;
            // Set linear and non-linear ad slot dimensions to match the global IMA ad container
            adsRequest.linearAdSlotWidth = imaAdContainer.offsetWidth;
            adsRequest.linearAdSlotHeight = imaAdContainer.offsetHeight;
            adsRequest.nonLinearAdSlotWidth = imaAdContainer.offsetWidth;
            adsRequest.nonLinearAdSlotHeight = imaAdContainer.offsetHeight;
            adsRequest.setAdWillAutoPlay(true); // Indicate that ads will autoplay

            adDisplayContainer.initialize(); // Initialize ad container before requesting ads
            adsLoader.requestAds(adsRequest);
            console.log("Ad request sent for:", video.id);
        }

        /**
         * Cleans up ad manager and reveals the video player.
         * @param {object} video - The video data.
         * @param {HTMLElement} playerContainer - The main container for video/ad (within the card).
         * @param {HTMLElement} thumbnail - The thumbnail element.
         * @param {HTMLElement} youtubeIframeWrapper - The wrapper for the YouTube iframe.
         * @param {HTMLElement} adMessageElement - The element to show message after ad.
         * @param {boolean} skipAd - If true, implies ad was skipped or failed, just show video.
         */
        function cleanupAdAndShowVideo(video, playerContainer, thumbnail, youtubeIframeWrapper, adMessageElement, skipAd = false) {
            console.log("Cleaning up ad and showing video for:", video.id, "Skip Ad (or failed):", skipAd);
            if (currentAdManager) {
                currentAdManager.destroy();
                currentAdManager = null;
            }
            imaAdContainer.style.display = 'none'; // Hide the global ad container
            document.querySelector('main').classList.remove('hidden'); // Show the main content area again

            isAdPlaying = false;
            thumbnail.classList.add('hidden'); // Keep thumbnail hidden
            youtubeIframeWrapper.classList.remove('hidden'); // Show iframe wrapper

            // Add YouTube iframe if not already present or if ad was skipped/failed
            let iframe = youtubeIframeWrapper.querySelector('iframe');
            if (!iframe) {
                const youTubeInfo = getYouTubeInfo(video.youtubeUrl);
                if (youTubeInfo) {
                    iframe = document.createElement('iframe');
                    iframe.className = "w-full h-full object-cover";
                    iframe.src = youTubeInfo.embedUrl;
                    iframe.frameBorder = "0";
                    iframe.allow = "autoplay; encrypted-media; gyroscope; picture-in-picture";
                    iframe.allowFullscreen = true;
                    iframe.title = "YouTube video player";
                    youtubeIframeWrapper.appendChild(iframe);
                } else {
                    youtubeIframeWrapper.innerHTML = `<div class="text-red-500 text-center">Invalid YouTube URL</div>`;
                    console.error("Invalid YouTube URL for video:", video.id, video.youtubeUrl);
                }
            } else {
                 // If iframe already exists, re-set its src to force autoplay/reload in case it was paused or not fully loaded
                 const youTubeInfo = getYouTubeInfo(video.youtubeUrl);
                 if (youTubeInfo) {
                    iframe.src = youTubeInfo.embedUrl;
                 }
            }

            // Display "Video playing soon!" message briefly
            adMessageElement.classList.remove('hidden');
            setTimeout(() => {
                adMessageElement.classList.add('hidden');
            }, 3000); // Hide message after 3 seconds
        }


        // --- Social Interactions (Like, Comment, Share) ---

        /**
         * Handles the like/unlike action for a video.
         * @param {string} videoId - The ID of the video.
         */
        async function handleLike(videoId) {
            if (!currentUserId || !db) {
                showCustomModal('Action Required', 'Please ensure you are signed in to like videos.', false);
                return;
            }
            console.log(`Liking/unliking video ${videoId} by user ${currentUserId}`);

            const likeRef = doc(db, `artifacts/${appId}/public/data/likes/${videoId}_${currentUserId}`);
            const videoRef = doc(db, `artifacts/${appId}/public/data/videos/${videoId}`);

            try {
                const docSnap = await getDoc(likeRef);
                const isLiked = docSnap.exists();

                const likeIcon = document.querySelector(`#like-button-${videoId} .like-icon`);
                let currentLikes = parseInt(document.querySelector(`#like-button-${videoId} .like-count`).textContent);

                if (isLiked) {
                    // Unlike
                    await deleteDoc(likeRef);
                    await updateDoc(videoRef, {
                        likesCount: Math.max(0, currentLikes - 1)
                    });
                    likeIcon.classList.remove('text-red-500', 'fill-current');
                    likeIcon.classList.add('text-gray-300');
                    likeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>';
                    console.log(`Video ${videoId} unliked.`);
                } else {
                    // Like
                    await setDoc(likeRef, { videoId: videoId, userId: currentUserId, timestamp: serverTimestamp() });
                    await updateDoc(videoRef, {
                        likesCount: (currentLikes || 0) + 1
                    });
                    likeIcon.classList.remove('text-gray-300');
                    likeIcon.classList.add('text-red-500', 'fill-current');
                    likeIcon.innerHTML = '<path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78L12 21.23l8.84-8.64a5.5 5.5 0 000-7.78z" fill="currentColor"></path>';
                    console.log(`Video ${videoId} liked.`);
                }
            } catch (error) {
                console.error("Error toggling like:", error);
                showCustomModal('Error', `Failed to update like: ${error.message}`, false);
            }
        }

        /**
         * Opens the comment modal for a specific video.
         * @param {string} videoId - The ID of the video to comment on.
         */
        function openCommentModal(videoId) {
            currentVideoIdForComments = videoId;
            commentModal.classList.remove('hidden');
            loadComments(videoId);
        }

        /**
         * Loads and displays comments for a given video.
         * @param {string} videoId - The ID of the video.
         */
        async function loadComments(videoId) {
            commentList.innerHTML = ''; // Clear previous comments
            commentLoading.classList.remove('hidden');
            noCommentsMessage.classList.add('hidden');

            if (!db) {
                console.error("Firestore DB not available for comments.");
                commentList.innerHTML = `<p class="text-red-500 text-center">App database not ready.</p>`;
                commentLoading.classList.add('hidden');
                return;
            }

            try {
                const commentsColRef = collection(db, `artifacts/${appId}/public/data/comments`);
                const q = query(commentsColRef, where('videoId', '==', videoId));

                onSnapshot(q, async (snapshot) => {
                    let fetchedComments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // Fetch usernames for comments
                    const commentsWithUsernames = await Promise.all(fetchedComments.map(async (comment) => {
                        const userProfileRef = doc(db, `artifacts/${appId}/users/${comment.userId}/profile/${comment.userId}`);
                        try {
                            const userDoc = await getDoc(userProfileRef);
                            const username = userDoc.exists() ? userDoc.data().username : 'Anonymous';
                            return { ...comment, username };
                        } catch (profileFetchError) {
                            console.warn("Could not fetch username for comment:", comment.userId, profileFetchError);
                            return { ...comment, username: 'Anonymous' }; // Fallback
                        }
                    }));

                    // Sort by timestamp descending
                    commentsWithUsernames.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

                    commentList.innerHTML = ''; // Clear again to prevent duplicates from multiple snapshots
                    if (commentsWithUsernames.length === 0) {
                        noCommentsMessage.classList.remove('hidden');
                    } else {
                        noCommentsMessage.classList.add('hidden');
                        commentsWithUsernames.forEach(comment => {
                            const commentElement = `
                                <div class="bg-gray-700 rounded-lg p-3 mb-3 shadow-sm border border-gray-600">
                                    <p class="text-gray-200 text-sm mb-1">${comment.text}</p>
                                    <p class="text-xs text-gray-400">
                                        <span class="font-semibold text-orange-300">${comment.username}</span> • ${new Date(comment.timestamp?.toDate()).toLocaleString()}
                                    </p>
                                </div>
                            `;
                            commentList.insertAdjacentHTML('beforeend', commentElement);
                        });
                    }
                    commentLoading.classList.add('hidden');
                }, (err) => {
                    console.error("Error in onSnapshot for comments:", err);
                    commentList.innerHTML = `<p class="text-red-500 text-center">Failed to load comments: ${err.message}. Check Firebase security rules.</p>`;
                    commentLoading.classList.add('hidden');
                });
            } catch (error) {
                console.error("Error setting up comment listener:", error);
                commentList.innerHTML = `<p class="text-red-500 text-center">Error fetching comments: ${error.message}.</p>`;
                commentLoading.classList.add('hidden');
            }
        }

        /**
         * Adds a new comment to a video.
         */
        async function addComment() {
            if (!currentUserId || !db) {
                showCustomModal('Action Required', 'Please ensure you are signed in to add comments.', false);
                return;
            }
            const commentText = newCommentInput.value.trim();
            if (!commentText) {
                showCustomModal('Input Required', 'Please enter a comment.', false);
                return;
            }
            if (!currentVideoIdForComments) {
                console.error("No video ID specified for comment.");
                showCustomModal('Error', 'Could not add comment: No video selected.', false);
                return;
            }

            try {
                const commentsColRef = collection(db, `artifacts/${appId}/public/data/comments`);
                await addDoc(commentsColRef, {
                    videoId: currentVideoIdForComments,
                    userId: currentUserId,
                    text: commentText,
                    timestamp: serverTimestamp()
                });
                newCommentInput.value = ''; // Clear input
                console.log("Comment added successfully.");
            } catch (error) {
                console.error("Error adding comment:", error);
                showCustomModal('Error', `Failed to add comment: ${error.message}`, false);
            }
        }

        /**
         * Shares a video link externally using the Web Share API.
         * @param {string} videoId - The ID of the video to share.
         * @param {string} title - The title of the video.
         * @param {string} url - The YouTube URL of the video.
         */
        function shareVideo(videoId, title, url) {
            // For a production app, you might want to generate a unique shareable link for your app
            // e.g., `https://yourapp.com/video/${videoId}`
            // For now, we'll share the YouTube URL itself or a generic app link.
            const shareUrl = url; // Directly share the YouTube URL for convenience

            if (navigator.share) {
                navigator.share({
                    title: `Check out this video on Video Fire: ${title}`,
                    text: `Watch "${title}" now on Video Fire!`,
                    url: shareUrl
                }).then(() => {
                    console.log('Video shared successfully!');
                }).catch((error) => {
                    console.error('Error sharing video:', error);
                    showCustomModal('Share Failed', `Could not share video: ${error.message}`, false);
                });
            } else {
                // Fallback for browsers that do not support Web Share API
                // Provide a text area to copy the link
                const fallbackMessage = `Sharing is not supported in your browser. You can manually copy the video link below: <br><br> <textarea class="w-full bg-gray-700 text-white rounded p-2 text-sm" rows="3" readonly>${shareUrl}</textarea>`;
                showCustomModal('Share Not Supported', fallbackMessage, false);
            }
        }


        // --- Upload Video Modal Logic ---

        /**
         * Opens the upload video modal.
         */
        function openUploadModal() {
            if (!currentUserId) {
                showCustomModal('Action Required', 'Please sign in or continue as guest to upload videos.', false);
                return;
            }
            uploadVideoModal.classList.remove('hidden');
        }

        /**
         * Handles video upload form submission.
         * @param {Event} e - The form submission event.
         */
        async function handleUploadSubmit(e) {
            e.preventDefault();
            uploadErrorMessage.classList.add('hidden');
            uploadSubmitButton.disabled = true;
            uploadButtonText.textContent = 'Uploading...';
            uploadLoadingSpinner.classList.remove('hidden');

            const videoUrl = videoUrlInput.value.trim();
            const videoTitle = videoTitleInput.value.trim();
            const videoDescription = videoDescriptionInput.value.trim();
            const videoTags = videoTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);

            const visibility = document.querySelector('input[name="video-visibility"]:checked').value;
            const videoType = document.querySelector('input[name="video-type"]:checked').value;

            const monetizationSettings = {
                vast: monetizeVast.checked,
                banner468x60: monetizeBanner468x60.checked,
                banner300x250: monetizeBanner300x250.checked,
                native: monetizeNative.checked
            };


            if (!videoUrl || !videoTitle) {
                uploadErrorMessage.textContent = "Please enter both video URL and title.";
                uploadErrorMessage.classList.remove('hidden');
                uploadSubmitButton.disabled = false;
                uploadButtonText.textContent = 'Upload Video';
                uploadLoadingSpinner.classList.add('hidden');
                return;
            }

            if (videoTitle.split(/\s+/).length > 100) { // Simple word count
                uploadErrorMessage.textContent = "Video title should not exceed 100 words.";
                uploadErrorMessage.classList.remove('hidden');
                uploadSubmitButton.disabled = false;
                uploadButtonText.textContent = 'Upload Video';
                uploadLoadingSpinner.classList.add('hidden');
                return;
            }

            if (videoTags.join(' ').split(/\s+/).length > 200) { // Simple word count for all tags combined
                uploadErrorMessage.textContent = "Video tags should not exceed 200 words.";
                uploadErrorMessage.classList.remove('hidden');
                uploadSubmitButton.disabled = false;
                uploadButtonText.textContent = 'Upload Video';
                uploadLoadingSpinner.classList.add('hidden');
                return;
            }

            const youTubeInfo = getYouTubeInfo(videoUrl);
            if (!youTubeInfo) {
                uploadErrorMessage.textContent = "Please enter a valid YouTube video URL.";
                uploadErrorMessage.classList.remove('hidden');
                uploadSubmitButton.disabled = false;
                uploadButtonText.textContent = 'Upload Video';
                uploadLoadingSpinner.classList.add('hidden');
                return;
            }

            if (!currentUserId || !db) {
                uploadErrorMessage.textContent = "App not ready or user not logged in.";
                uploadErrorMessage.classList.remove('hidden');
                uploadSubmitButton.disabled = false;
                uploadButtonText.textContent = 'Upload Video';
                uploadLoadingSpinner.classList.add('hidden');
                return;
            }

            try {
                // Fetch current user's username
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/${currentUserId}`);
                const userDoc = await getDoc(userProfileRef);
                const username = userDoc.exists() ? userDoc.data().username : 'Anonymous';

                const videosColRef = collection(db, `artifacts/${appId}/public/data/videos`);
                await addDoc(videosColRef, {
                    userId: currentUserId,
                    userName: username,
                    youtubeUrl: videoUrl,
                    title: videoTitle,
                    description: videoDescription,
                    tags: videoTags,
                    thumbnailUrl: youTubeInfo.thumbnailUrl,
                    viewsCount: 0,
                    likesCount: 0,
                    timestamp: serverTimestamp(),
                    visibility: visibility,
                    videoType: videoType, // Save video type
                    monetization: monetizationSettings
                });

                showCustomModal('Success!', 'Video uploaded successfully. It will appear in the feed shortly.', false, null, () => {
                    closeModal('upload');
                });
                uploadVideoForm.reset(); // Clear form
            } catch (error) {
                console.error("Error uploading video:", error);
                uploadErrorMessage.textContent = `Failed to upload video: ${error.message}. Please check Firebase security rules.`;
                uploadErrorMessage.classList.remove('hidden');
            } finally {
                uploadSubmitButton.disabled = false;
                uploadButtonText.textContent = 'Upload Video';
                uploadLoadingSpinner.classList.add('hidden');
            }
        }


        // --- Withdraw Modal Logic (Simulated) ---

        /**
         * Opens the withdraw modal.
         */
        function openWithdrawModal() {
            if (!currentUserId) {
                showCustomModal('Action Required', 'Please sign in to request withdrawal.', false);
                return;
            }
            withdrawModal.classList.remove('hidden');
        }

        /**
         * Handles withdrawal form submission (simulated).
         * @param {Event} e - The form submission event.
         */
        async function handleWithdrawSubmit(e) {
            e.preventDefault();
            withdrawErrorMessage.classList.add('hidden');
            withdrawSubmitButton.disabled = true;
            withdrawButtonText.textContent = 'Submitting...';
            withdrawLoadingSpinner.classList.remove('hidden');

            const amount = parseFloat(withdrawAmountInput.value);
            const upiId = upiIdInput.value.trim();

            if (!amount || !upiId) {
                withdrawErrorMessage.textContent = 'Please fill all fields.';
                withdrawErrorMessage.classList.remove('hidden');
                withdrawSubmitButton.disabled = false;
                withdrawButtonText.textContent = 'Request Withdrawal';
                withdrawLoadingSpinner.classList.add('hidden');
                return;
            }
            if (amount < 100) {
                withdrawErrorMessage.textContent = 'Minimum withdrawal amount is ₹100.';
                withdrawErrorMessage.classList.remove('hidden');
                withdrawSubmitButton.disabled = false;
                withdrawButtonText.textContent = 'Request Withdrawal';
                withdrawLoadingSpinner.classList.add('hidden');
                return;
            }
             if (!currentUserId) {
                withdrawErrorMessage.textContent = "User not logged in. Cannot process withdrawal.";
                withdrawErrorMessage.classList.remove('hidden');
                withdrawSubmitButton.disabled = false;
                withdrawButtonText.textContent = 'Request Withdrawal';
                withdrawLoadingSpinner.classList.add('hidden');
                return;
            }


            try {
                // Simulate API call for withdrawal request
                console.log(`Withdrawal Request: User ${currentUserId}, Amount: ₹${amount}, UPI ID: ${upiId}`);
                await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate 2-second delay

                showCustomModal('Request Sent!', 'Withdrawal request submitted successfully! Payment will be sent manually via UPI.', false, null, () => {
                    closeModal('withdraw');
                });
                withdrawForm.reset(); // Clear form
            } catch (error) {
                console.error("Withdrawal error:", error);
                withdrawErrorMessage.textContent = `Failed to submit withdrawal request: ${error.message}`;
                withdrawErrorMessage.classList.remove('hidden');
            } finally {
                withdrawSubmitButton.disabled = false;
                withdrawButtonText.textContent = 'Request Withdrawal';
                withdrawLoadingSpinner.classList.add('hidden');
            }
        }

        /**
         * Handles user sign out.
         */
        async function handleSignOut() {
            try {
                await signOut(auth);
                console.log("Signed out successfully.");
                currentUserId = null; // Clear userId after sign out
                showPage('home'); // Redirect to home page
                showCustomModal('Signed Out', 'You have been signed out successfully.', false);
            } catch (error) {
                console.error("Error signing out:", error);
                showCustomModal('Sign Out Error', `Failed to sign out: ${error.message}`, false);
            }
        }


        // --- Authentication Modal Functions ---

        /**
         * Switches the active tab in the auth modal between Login and Sign Up.
         * @param {string} type - 'login' or 'signup'.
         */
        function switchAuthTab(type) {
            if (type === 'login') {
                authTabLogin.classList.add('bg-orange-500', 'text-white');
                authTabLogin.classList.remove('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                authTabSignup.classList.remove('bg-orange-500', 'text-white');
                authTabSignup.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            } else { // type === 'signup'
                authTabSignup.classList.add('bg-orange-500', 'text-white');
                authTabSignup.classList.remove('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                authTabLogin.classList.remove('bg-orange-500', 'text-white');
                authTabLogin.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                signupForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
            loginErrorMessage.classList.add('hidden');
            signupErrorMessage.classList.add('hidden');
        }

        /**
         * Handles Email/Password Sign Up.
         * @param {Event} e - The form submission event.
         */
        async function handleEmailSignup(e) {
            e.preventDefault();
            signupErrorMessage.classList.add('hidden');
            signupSubmitButton.disabled = true;
            signupButtonText.textContent = 'Signing Up...';
            signupLoadingSpinner.classList.remove('hidden');

            const email = signupEmailInput.value.trim();
            const password = signupPasswordInput.value.trim();

            if (!email || !password) {
                signupErrorMessage.textContent = "Please enter both email and password.";
                signupErrorMessage.classList.remove('hidden');
                signupSubmitButton.disabled = false;
                signupButtonText.textContent = 'Sign Up';
                signupLoadingSpinner.classList.add('hidden');
                return;
            }
            if (password.length < 6) {
                signupErrorMessage.textContent = "Password must be at least 6 characters long.";
                signupErrorMessage.classList.remove('hidden');
                signupSubmitButton.disabled = false;
                signupButtonText.textContent = 'Sign Up';
                signupLoadingSpinner.classList.add('hidden');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                console.log("User signed up:", user.uid);

                // Send email verification
                await sendEmailVerification(user);
                showCustomModal('Verification Sent', `A verification email has been sent to ${user.email}. Please verify your email before logging in.`, false, null, () => {
                    closeModal('auth'); // Close auth modal on successful signup and email sent
                });
                signupForm.reset();
            } catch (error) {
                console.error("Signup error:", error);
                let errorMessage = "Failed to sign up.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "This email is already in use. Try logging in.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email address.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Password is too weak.";
                }
                signupErrorMessage.textContent = errorMessage;
                signupErrorMessage.classList.remove('hidden');
            } finally {
                signupSubmitButton.disabled = false;
                signupButtonText.textContent = 'Sign Up';
                signupLoadingSpinner.classList.add('hidden');
            }
        }

        /**
         * Handles Email/Password Login.
         * @param {Event} e - The form submission event.
         */
        async function handleEmailLogin(e) {
            e.preventDefault();
            loginErrorMessage.classList.add('hidden');
            loginSubmitButton.disabled = true;
            loginButtonText.textContent = 'Logging In...';
            loginLoadingSpinner.classList.remove('hidden');

            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value.trim();

            if (!email || !password) {
                loginErrorMessage.textContent = "Please enter both email and password.";
                loginErrorMessage.classList.remove('hidden');
                loginSubmitButton.disabled = false;
                loginButtonText.textContent = 'Login';
                loginLoadingSpinner.classList.add('hidden');
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                console.log("User logged in:", user.uid);

                if (!user.emailVerified) {
                    showCustomModal('Email Not Verified', 'Your email is not verified. Please check your inbox for a verification link. Or click Ok to resend email.', true, async () => {
                        await sendEmailVerification(user);
                        showCustomModal('Email Sent', 'Verification email resent!', false);
                    });
                    await signOut(auth); // Sign out if email is not verified
                } else {
                    // Success, onAuthStateChanged will handle UI update
                    console.log("User logged in and email verified.");
                    loginForm.reset();
                    closeModal('auth');
                }
            } catch (error) {
                console.error("Login error:", error);
                let errorMessage = "Failed to log in.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Invalid email or password.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email address.";
                }
                loginErrorMessage.textContent = errorMessage;
                loginErrorMessage.classList.remove('hidden');
            } finally {
                loginSubmitButton.disabled = false;
                loginButtonText.textContent = 'Login';
                loginLoadingSpinner.classList.add('hidden');
            }
        }

        /**
         * Handles Google Sign-in.
         */
        async function handleGoogleSignIn() {
            googleSignInButton.disabled = true;
            guestLoginButton.disabled = true; // Disable other buttons during sign-in
            loginSubmitButton.disabled = true;
            signupSubmitButton.disabled = true;

            try {
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                console.log("Google signed in user:", user.uid);
                // onAuthStateChanged will handle UI update and profile creation
                closeModal('auth');
            } catch (error) {
                console.error("Google Sign-in error:", error);
                if (error.code === 'auth/popup-closed-by-user') {
                    console.log("Google Sign-in popup closed by user.");
                } else {
                    showCustomModal('Google Sign-in Error', `Failed to sign in with Google: ${error.message}`, false);
                }
            } finally {
                googleSignInButton.disabled = false;
                guestLoginButton.disabled = false;
                loginSubmitButton.disabled = false;
                signupSubmitButton.disabled = false;
            }
        }

        /**
         * Handles Forgot Password flow.
         */
        async function handleForgotPassword() {
            const email = loginEmailInput.value.trim();
            if (!email) {
                loginErrorMessage.textContent = "Please enter your email to reset password.";
                loginErrorMessage.classList.remove('hidden');
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                showCustomModal('Password Reset', `Password reset email sent to ${email}. Check your inbox.`, false);
                loginErrorMessage.classList.add('hidden');
            } catch (error) {
                console.error("Forgot password error:", error);
                let errorMessage = "Failed to send password reset email.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "No user found with this email.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email address.";
                }
                loginErrorMessage.textContent = errorMessage;
                loginErrorMessage.classList.remove('hidden');
            }
        }

        /**
         * Handles "Continue as Guest" (anonymous login).
         */
        async function handleGuestLogin() {
            guestLoginButton.disabled = true;
            guestLoginButtonText.textContent = 'Logging In...';
            guestLoginLoadingSpinner.classList.remove('hidden');
            googleSignInButton.disabled = true;
            loginSubmitButton.disabled = true;
            signupSubmitButton.disabled = true;

            try {
                await signInAnonymously(auth);
                // onAuthStateChanged will handle UI update and profile creation
                closeModal('auth');
            } catch (error) {
                console.error("Guest login error:", error);
                showCustomModal('Guest Login Error', `Failed to sign in as guest: ${error.message}. Please try again.`, false);
            } finally {
                guestLoginButton.disabled = false;
                guestLoginButtonText.textContent = 'Continue as Guest';
                guestLoginLoadingSpinner.classList.add('hidden');
                googleSignInButton.disabled = false;
                loginSubmitButton.disabled = false;
                signupSubmitButton.disabled = false;
            }
        }


        // --- Ad Script Injection (Global) ---
        // Dynamically create and append script elements for third-party ads.

        function loadScript(src, type = 'text/javascript', parent = document.body) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.type = type;
                script.async = true;
                script.referrerPolicy = 'no-referrer-when-downgrade'; // For some ad networks

                script.onload = () => {
                    console.log(`Script loaded: ${src}`);
                    resolve(script);
                };
                script.onerror = (e) => {
                    console.error(`Error loading script: ${src}`, e);
                    reject(new Error(`Failed to load script ${src}`));
                };
                parent.appendChild(script);
            });
        }

        function injectExternalAdScripts() {
            console.log("Injecting external ad scripts (minimal global ads)...");

            // Only load Adstreaa Social Bar globally, as it's less intrusive.
            // Other ads are handled per video based on monetization settings.
            loadScript('//pl26835180.profitableratecpm.com/51/87/c3/5187c39d0d72d45de29e9c62b51aaba2.js');

            console.log("All global external ad scripts initiated for injection.");
        }


        // --- Search Functionality ---
        function performSearch(query) {
            const currentVideoType = currentPage === 'shorts' ? 'short' : 'long';
            updateVideoFeed(currentVideoType, query);
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Content Loaded. Starting app initialization.");
            // Initialize Firebase when DOM is ready
            initializeFirebase();

            // Inject global ad scripts
            injectExternalAdScripts();

            // Header Button Listeners
            // Toggle search bar visibility
            document.getElementById('search-button').addEventListener('click', () => {
                if (headerSearchContainer.classList.contains('hidden')) {
                    headerSearchContainer.classList.remove('hidden');
                    headerSearchContainer.classList.add('active'); // Mark as active for persistent visibility
                    headerButtonsContainer.classList.add('hidden');
                    headerSearchInput.focus();
                } else {
                    // If search bar is visible, clicking search button again hides it and clears search
                    headerSearchContainer.classList.add('hidden');
                    headerSearchContainer.classList.remove('active'); // Remove active state
                    headerButtonsContainer.classList.remove('hidden');
                    headerSearchInput.value = ''; // Clear search on close
                    // Re-fetch videos without search filter
                    const currentVideoType = currentPage === 'shorts' ? 'short' : 'long';
                    updateVideoFeed(currentVideoType);
                }
            });
            clearSearchButton.addEventListener('click', () => {
                headerSearchInput.value = '';
                const currentVideoType = currentPage === 'shorts' ? 'short' : 'long';
                updateVideoFeed(currentVideoType); // Clear search filter
                headerSearchInput.focus();
            });
            headerSearchInput.addEventListener('input', (e) => {
                performSearch(e.target.value);
            });


            document.getElementById('profile-header-button').addEventListener('click', () => showPage('profile'));
            document.getElementById('upload-footer-button').addEventListener('click', openUploadModal); // Upload button moved to footer
            document.getElementById('withdraw-header-button').addEventListener('click', openWithdrawModal);
            signOutButton.addEventListener('click', handleSignOut);

            // Footer Button Listeners
            document.getElementById('home-footer-button').addEventListener('click', () => showPage('home'));
            document.getElementById('shorts-footer-button').addEventListener('click', () => showPage('shorts')); // New Shorts button
            document.getElementById('people-footer-button').addEventListener('click', () => showPage('people'));
            document.getElementById('profile-footer-button').addEventListener('click', () => showPage('profile'));

            // Custom Modal Listeners (delegated as modal is shown/hidden)
            customModalCloseButton.addEventListener('click', () => closeModal('custom'));
            // The confirm button's listener is set dynamically in showCustomModal

            // Comment Modal Listeners
            commentModalCloseButton.addEventListener('click', () => closeModal('comment'));
            addCommentButton.addEventListener('click', addComment);
            newCommentInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addComment();
                }
            });

            // Upload Modal Listeners
            uploadModalCloseButton.addEventListener('click', () => closeModal('upload'));
            uploadVideoForm.addEventListener('submit', handleUploadSubmit);

            // Withdraw Modal Listeners
            withdrawModalCloseButton.addEventListener('click', () => closeModal('withdraw'));
            withdrawForm.addEventListener('submit', handleWithdrawSubmit);

            // Authentication Modal Listeners
            authTabLogin.addEventListener('click', () => switchAuthTab('login'));
            authTabSignup.addEventListener('click', () => switchAuthTab('signup'));
            loginForm.addEventListener('submit', handleEmailLogin);
            signupForm.addEventListener('submit', handleEmailSignup);
            googleSignInButton.addEventListener('click', handleGoogleSignIn);
            guestLoginButton.addEventListener('click', handleGuestLogin);
            forgotPasswordButton.addEventListener('click', handleForgotPassword);

            // Profile Page Tabs (New)
            profileTabVideos.addEventListener('click', () => updateProfilePage('long'));
            profileTabShorts.addEventListener('click', () => updateProfilePage('short'));
        });

        // Ensure window resize updates IMA ad container size if needed,
        // though the global container should handle it fairly well with CSS.
        window.addEventListener('resize', () => {
            if (currentAdManager && imaAdContainer.style.display !== 'none') {
                 // Important: Re-init or resize ad manager if container dimensions change while ad is active
                currentAdManager.resize(imaAdContainer.offsetWidth, imaAdContainer.offsetHeight, google.ima.ViewMode.NORMAL);
            }
        });

    </script>
</body>
</html>
