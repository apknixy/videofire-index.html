<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoApp</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        .video-card {
            background-color: #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative; /* For ad placement */
        }
        .video-card:hover {
            transform: translateY(-5px);
        }
        .thumbnail-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            background-color: #000;
        }
        .thumbnail-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .shorts-thumbnail-container {
            position: relative;
            width: 100%;
            padding-bottom: 177.77%; /* 9:16 Aspect Ratio */
            background-color: #000;
        }
        .shorts-thumbnail-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .shorts-reel {
            scroll-snap-type: y mandatory;
            overflow-y: scroll;
            height: calc(100vh - 120px); /* Adjust based on header/footer */
            -webkit-overflow-scrolling: touch;
        }
        .shorts-reel > div {
            scroll-snap-align: start;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #2a2a2a;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }
        .video-player-modal .modal-content {
            width: 95%;
            max-width: 900px; /* Wider for better video view */
            background: none;
            padding: 0;
        }
        .video-player-iframe-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            background-color: #000;
        }
        .video-player-iframe-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        .ad-container {
            margin-top: 1rem;
            text-align: center;
        }
        .video-details {
            padding: 1rem;
        }
        .video-details h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .video-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        .video-actions button {
            background-color: #3a3a3a;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #2a2a2a;
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            border-top: 1px solid #3a3a3a;
            z-index: 50;
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #aaa;
            font-size: 0.75rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
        }
        .bottom-nav-item.active {
            color: #fff;
        }
        .bottom-nav-item i {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }
        .upload-button-nav {
            background-color: #ff0000;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: #fff;
            position: relative;
            top: -10px; /* Lift it slightly above the nav bar */
            box-shadow: 0px 2px 10px rgba(0,0,0,0.5);
        }
        .login-modal-content {
            background-color: #2a2a2a;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1rem;
            color: #fff;
            font-size: 1.2rem;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .auth-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .auth-container input {
            background-color: #3a3a3a;
            border: 1px solid #4a4a4a;
            padding: 0.75rem;
            border-radius: 4px;
            color: #fff;
        }
        .auth-container button {
            background-color: #ff0000;
            padding: 0.75rem;
            border-radius: 4px;
            font-weight: bold;
            color: #fff;
            transition: background-color 0.2s;
        }
        .auth-container button:hover {
            background-color: #cc0000;
        }
        .google-signin-button {
            background-color: #4285f4 !important; /* Google Blue */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .google-signin-button:hover {
            background-color: #357ae8 !important;
        }
        .guest-button {
            background-color: #555 !important;
        }
        .guest-button:hover {
            background-color: #444 !important;
        }
        .ad-banner-468x60 {
            width: 468px;
            height: 60px;
            background-color: #333;
            color: #eee;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            border-radius: 4px;
            margin: 10px auto;
        }
        .ad-banner-300x250 {
            width: 300px;
            height: 250px;
            background-color: #333;
            color: #eee;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem;
            border-radius: 4px;
            margin: 10px auto;
        }
        .ad-native {
            background-color: #2b2b2b;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 10px auto;
            max-width: 400px;
        }
        .ad-native .ad-title {
            font-weight: bold;
            font-size: 1.1rem;
        }
        .ad-native .ad-description {
            font-size: 0.9rem;
            color: #bbb;
        }
        .ad-native .ad-cta {
            background-color: #007bff;
            color: #fff;
            padding: 8px 12px;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            font-size: 0.9rem;
        }
        /* Style for tags */
        .tag-pill {
            display: inline-block;
            background-color: #3a3a3a;
            color: #bbb;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        #commentSection {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #333;
        }
        #commentInput {
            width: 100%;
            background-color: #3a3a3a;
            border: 1px solid #4a4a4a;
            padding: 0.75rem;
            border-radius: 4px;
            color: #fff;
            margin-bottom: 0.5rem;
        }
        #commentButton {
            background-color: #ff0000;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            color: #fff;
            font-weight: bold;
        }
        .comment-item {
            background-color: #2b2b2b;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        .comment-item strong {
            color: #ff0000;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script type="text/javascript" src="//imasdk.googleapis.com/js/sdkloader/ima3.js"></script>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loadingMessage">Loading app...</p>
    </div>

    <div id="authModal" class="modal">
        <div class="login-modal-content">
            <h2 class="text-2xl font-bold mb-4">Welcome to VideoApp</h2>
            <div class="auth-container">
                <input type="email" id="authEmail" placeholder="Email" class="w-full">
                <input type="password" id="authPassword" placeholder="Password" class="w-full">
                <button id="authLoginButton" class="w-full">Login</button>
                <button id="authSignupButton" class="w-full bg-blue-600 hover:bg-blue-700">Sign Up</button>
                <button id="authGoogleSignIn" class="google-signin-button w-full">
                    <i class="fab fa-google"></i> Sign In with Google
                </button>
                <button id="authGuestButton" class="guest-button w-full">Continue as Guest</button>
                <button id="authForgotPassword" class="text-sm text-gray-400 mt-2 hover:text-white">Forgot Password?</button>
            </div>
            <p id="authMessage" class="text-red-500 mt-4"></p>
        </div>
    </div>

    <div id="appContainer" class="hidden">
        <header class="bg-gray-800 p-4 flex justify-between items-center sticky top-0 z-40">
            <h1 class="text-2xl font-bold">VideoApp</h1>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="Search..." class="bg-gray-700 text-white rounded-full py-2 px-4 focus:outline-none focus:ring-2 focus:ring-red-500">
                    <button id="searchButton" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <button id="profileButton" class="text-white hover:text-gray-300">
                    <i class="fas fa-user-circle text-2xl"></i>
                </button>
                <button id="signOutButton" class="text-sm bg-red-600 px-3 py-1 rounded hover:bg-red-700">Sign Out</button>
            </div>
        </header>

        <main class="container py-4">
            <section id="homeSection" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                </section>

            <section id="shortsSection" class="hidden shorts-reel">
                </section>

            <div id="uploadModal" class="modal">
                <div class="modal-content">
                    <span class="close-button" onclick="closeUploadModal()">&times;</span>
                    <h2 class="text-2xl font-bold mb-4">Upload Video</h2>
                    <div class="flex flex-col space-y-4">
                        <input type="text" id="videoUrlInput" placeholder="YouTube Video URL" class="bg-gray-700 p-2 rounded">
                        <input type="text" id="videoTitleInput" placeholder="Video Title (max 100 words)" class="bg-gray-700 p-2 rounded" maxlength="100">
                        <textarea id="videoDescriptionInput" placeholder="Video Description" class="bg-gray-700 p-2 rounded h-24 resize-none"></textarea>
                        <input type="text" id="videoTagsInput" placeholder="Tags (comma separated, max 200 words)" class="bg-gray-700 p-2 rounded" maxlength="200">

                        <div class="flex items-center space-x-4">
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="videoType" value="normal" checked class="form-radio text-red-500">
                                <span>Long Video</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="videoType" value="short" class="form-radio text-red-500">
                                <span>Short</span>
                            </label>
                        </div>

                        <div class="flex items-center space-x-4">
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="videoVisibility" value="public" checked class="form-radio text-red-500">
                                <span>Public</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="videoVisibility" value="private" class="form-radio text-red-500">
                                <span>Private</span>
                            </label>
                        </div>

                        <div class="bg-gray-800 p-4 rounded-md">
                            <h3 class="text-lg font-semibold mb-2">Monetization Settings</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="monetizeVast" checked class="form-checkbox text-red-500 rounded">
                                    <span>VAST Ads</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="monetizeBanner468" checked class="form-checkbox text-red-500 rounded">
                                    <span>Banner 468x60</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="monetizeBanner300" checked class="form-checkbox text-red-500 rounded">
                                    <span>Banner 300x250</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="monetizeNative" checked class="form-checkbox text-red-500 rounded">
                                    <span>Native Ads</span>
                                </label>
                            </div>
                        </div>

                        <button id="uploadVideoButton" class="bg-red-600 p-2 rounded font-bold hover:bg-red-700">Upload</button>
                        <p id="uploadMessage" class="text-green-500 mt-2"></p>
                    </div>
                </div>
            </div>

            <div id="videoPlayerModal" class="modal video-player-modal">
                <div class="modal-content">
                    <span class="close-button" onclick="closeVideoPlayerModal()">&times;</span>
                    <div id="vastAdContainer" style="width: 100%; height: 400px; display: none;"></div>
                    <div id="contentPlayer" class="video-player-iframe-container" style="display: none;">
                        <iframe id="youtubePlayer" allowfullscreen></iframe>
                    </div>
                    <div id="adPlayMessage" class="text-center text-xl mt-4 hidden">Ad playing...</div>

                    <div id="videoDetailsContainer" class="video-details hidden">
                        <h2 id="videoPlayerTitle" class="text-xl font-bold mb-2"></h2>
                        <div class="text-sm text-gray-400 mb-2">
                            <span id="videoPlayerChannel"></span> â€¢ <span id="videoPlayerViews"></span> views
                        </div>
                        <p id="videoPlayerDescription" class="text-gray-300 text-sm mb-3"></p>
                        <div id="videoPlayerTags" class="flex flex-wrap gap-2 mb-4"></div>

                        <div class="video-actions">
                            <button id="likeButton"><i class="fas fa-thumbs-up"></i> <span id="likeCount">0</span></button>
                            <button id="shareButton"><i class="fas fa-share"></i> Share</button>
                        </div>

                        <div id="adContainerVideoPlayer" class="ad-container grid grid-cols-1 md:grid-cols-2 gap-4">
                            </div>

                        <div id="commentSection">
                            <h3 class="text-lg font-semibold mb-2">Comments</h3>
                            <input type="text" id="commentInput" placeholder="Add a comment..." class="mb-2">
                            <button id="commentButton">Post Comment</button>
                            <div id="commentsList" class="mt-4 max-h-60 overflow-y-auto">
                                </div>
                        </div>
                    </div>
                </div>
            </div>


            <section id="profileSection" class="hidden">
                <div class="flex flex-col items-center p-6 bg-gray-800 rounded-lg shadow-lg mb-8">
                    <i class="fas fa-user-circle text-6xl text-gray-400 mb-4"></i>
                    <h2 id="profileUsername" class="text-3xl font-bold mb-2">Guest User</h2>
                    <p id="profileUserId" class="text-gray-400 text-sm">User ID: N/A</p>
                </div>

                <h3 class="text-2xl font-bold mb-4">My Uploaded Videos</h3>
                <div id="myVideosList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    </div>
                <p id="noVideosMessage" class="text-gray-400 text-center mt-8 hidden">You haven't uploaded any videos yet.</p>
            </section>

            <section id="searchResultsSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Search Results for "<span id="searchQueryDisplay"></span>"</h2>
                <div id="searchResultsList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    </div>
                <p id="noSearchResultsMessage" class="text-gray-400 text-center mt-8 hidden">No videos found for your search.</p>
            </section>

             <section id="subscriptionsSection" class="hidden text-center py-20">
                <h2 class="text-4xl font-bold mb-4">Subscriptions</h2>
                <p class="text-gray-400">This feature is coming soon!</p>
            </section>

            <section id="librarySection" class="hidden text-center py-20">
                <h2 class="text-4xl font-bold mb-4">Library</h2>
                <p class="text-gray-400">This feature is coming soon!</p>
            </section>


        </main>

        <nav class="bottom-nav">
            <div class="bottom-nav-item active" onclick="showSection('home')">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
            <div class="bottom-nav-item" onclick="showSection('shorts')">
                <i class="fas fa-bolt"></i>
                <span>Shorts</span>
            </div>
            <div class="bottom-nav-item upload-button-nav" onclick="openUploadModal()">
                <i class="fas fa-plus"></i>
            </div>
            <div class="bottom-nav-item" onclick="showSection('subscriptions')">
                <i class="fas fa-youtube"></i>
                <span>Subscriptions</span>
            </div>
            <div class="bottom-nav-item" onclick="showSection('library')">
                <i class="fas fa-book"></i>
                <span>Library</span>
            </div>
        </nav>
    </div>

    <script>
        // Firebase Configuration (Replace with your actual Firebase project config)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const appId = firebaseConfig.appId; // Use the app ID from config

        let currentUser = null;
        let adsManager = null;
        let adsLoader = null;
        let adDisplayContainer = null;
        let intervalTimer = null;
        let currentVideoData = null; // To store current video's full data

        const sections = ['homeSection', 'shortsSection', 'uploadModal', 'videoPlayerModal', 'profileSection', 'searchResultsSection', 'subscriptionsSection', 'librarySection'];
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingMessage = document.getElementById('loadingMessage');
        const authModal = document.getElementById('authModal');
        const appContainer = document.getElementById('appContainer');

        const homeSection = document.getElementById('homeSection');
        const shortsSection = document.getElementById('shortsSection');
        const uploadModal = document.getElementById('uploadModal');
        const videoPlayerModal = document.getElementById('videoPlayerModal');
        const profileSection = document.getElementById('profileSection');
        const searchResultsSection = document.getElementById('searchResultsSection');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const searchQueryDisplay = document.getElementById('searchQueryDisplay');
        const searchResultsList = document.getElementById('searchResultsList');
        const noSearchResultsMessage = document.getElementById('noSearchResultsMessage');

        // Elements for authentication
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const authLoginButton = document.getElementById('authLoginButton');
        const authSignupButton = document.getElementById('authSignupButton');
        const authGoogleSignIn = document.getElementById('authGoogleSignIn');
        const authGuestButton = document.getElementById('authGuestButton');
        const authForgotPassword = document.getElementById('authForgotPassword');
        const authMessage = document.getElementById('authMessage');
        const signOutButton = document.getElementById('signOutButton');
        const profileButton = document.getElementById('profileButton');

        // Elements for video upload
        const videoUrlInput = document.getElementById('videoUrlInput');
        const videoTitleInput = document.getElementById('videoTitleInput');
        const videoDescriptionInput = document.getElementById('videoDescriptionInput');
        const videoTagsInput = document.getElementById('videoTagsInput');
        const uploadVideoButton = document.getElementById('uploadVideoButton');
        const uploadMessage = document.getElementById('uploadMessage');
        const monetizeVast = document.getElementById('monetizeVast');
        const monetizeBanner468 = document.getElementById('monetizeBanner468');
        const monetizeBanner300 = document.getElementById('monetizeBanner300');
        const monetizeNative = document.getElementById('monetizeNative');

        // Elements for video player
        const youtubePlayer = document.getElementById('youtubePlayer');
        const vastAdContainer = document.getElementById('vastAdContainer');
        const contentPlayer = document.getElementById('contentPlayer');
        const adPlayMessage = document.getElementById('adPlayMessage');
        const videoPlayerTitle = document.getElementById('videoPlayerTitle');
        const videoPlayerChannel = document.getElementById('videoPlayerChannel');
        const videoPlayerViews = document.getElementById('videoPlayerViews');
        const videoPlayerDescription = document.getElementById('videoPlayerDescription');
        const videoPlayerTags = document.getElementById('videoPlayerTags');
        const likeButton = document.getElementById('likeButton');
        const likeCount = document.getElementById('likeCount');
        const shareButton = document.getElementById('shareButton');
        const commentInput = document.getElementById('commentInput');
        const commentButton = document.getElementById('commentButton');
        const commentsList = document.getElementById('commentsList');
        const adContainerVideoPlayer = document.getElementById('adContainerVideoPlayer');

        // Profile elements
        const profileUsername = document.getElementById('profileUsername');
        const profileUserId = document.getElementById('profileUserId');
        const myVideosList = document.getElementById('myVideosList');
        const noVideosMessage = document.getElementById('noVideosMessage');

        // --- Utility Functions ---
        function showLoading(message = 'Loading...') {
            loadingMessage.textContent = message;
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function showSection(sectionId) {
            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    section.classList.add('hidden');
                }
            });
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }

            // Update active state in bottom nav
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeNavItem = document.querySelector(`.bottom-nav-item[onclick="showSection('${sectionId}')"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            } else if (sectionId === 'uploadModal' || sectionId === 'videoPlayerModal' || sectionId === 'profileSection') {
                 // For modals and profile, no bottom nav item explicitly active
            } else if (sectionId === 'searchResultsSection') {
                // No active state for search results, as it's not a primary nav item
            }
        }

        function openUploadModal() {
            if (!currentUser || currentUser.isAnonymous) {
                alert('Please sign in to upload videos.');
                showAuthModal();
                return;
            }
            uploadModal.classList.remove('hidden');
            uploadModal.style.display = 'flex';
        }

        function closeUploadModal() {
            uploadModal.classList.add('hidden');
            uploadModal.style.display = 'none';
            videoUrlInput.value = '';
            videoTitleInput.value = '';
            videoDescriptionInput.value = '';
            videoTagsInput.value = '';
            uploadMessage.textContent = '';
            document.querySelector('input[name="videoType"][value="normal"]').checked = true;
            document.querySelector('input[name="videoVisibility"][value="public"]').checked = true;
            monetizeVast.checked = true;
            monetizeBanner468.checked = true;
            monetizeBanner300.checked = true;
            monetizeNative.checked = true;
        }

        function openVideoPlayerModal(video) {
            currentVideoData = video; // Store the full video data
            videoPlayerModal.classList.remove('hidden');
            videoPlayerModal.style.display = 'flex';

            videoPlayerTitle.textContent = video.title;
            videoPlayerChannel.textContent = video.uploaderName || 'Unknown Uploader';
            videoPlayerViews.textContent = `${(video.views || 0).toLocaleString()} views`;
            videoPlayerDescription.textContent = video.description || 'No description available.';
            videoPlayerTags.innerHTML = '';
            if (video.tags && video.tags.length > 0) {
                video.tags.forEach(tag => {
                    const tagPill = document.createElement('span');
                    tagPill.className = 'tag-pill';
                    tagPill.textContent = tag.trim();
                    videoPlayerTags.appendChild(tagPill);
                });
            } else {
                videoPlayerTags.textContent = 'No tags.';
            }

            likeCount.textContent = video.likes || 0;
            updateLikeButtonState(video.id);
            fetchComments(video.id);

            // Hide content player initially, show ad container
            contentPlayer.style.display = 'none';
            vastAdContainer.style.display = 'block';
            adPlayMessage.classList.remove('hidden');

            // Initialize and play VAST ad if enabled
            if (video.monetization && video.monetization.vast) {
                console.log('VAST ads are enabled for this video. Attempting to play ad.');
                requestVastAd(video.youtubeId); // Pass YouTube ID for a unique ad tag or context
            } else {
                console.log('VAST ads are disabled for this video, or no ad unit provided. Playing video directly.');
                playVideoDirectly(video.youtubeId);
            }

            // Load other ad types based on monetization settings
            loadDynamicAds(video.monetization);
        }

        function closeVideoPlayerModal() {
            videoPlayerModal.classList.add('hidden');
            videoPlayerModal.style.display = 'none';
            youtubePlayer.src = ''; // Stop video playback
            vastAdContainer.style.display = 'none';
            adPlayMessage.classList.add('hidden');
            contentPlayer.style.display = 'none';
            adContainerVideoPlayer.innerHTML = ''; // Clear ads
            commentsList.innerHTML = ''; // Clear comments
            if (adsManager) {
                adsManager.destroy();
                adsManager = null;
            }
            if (adsLoader) {
                adsLoader.destroy(); // Important for IMA SDK
                adsLoader = null;
            }
            if (intervalTimer) {
                clearInterval(intervalTimer);
                intervalTimer = null;
            }
            currentVideoData = null; // Clear current video data
        }

        function getYoutubeId(url) {
            const regExp = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
            const match = url.match(regExp);
            return (match && match[1]) ? match[1] : null;
        }

        function getYoutubeThumbnail(youtubeId, quality = 'hqdefault') {
            return `https://img.youtube.com/vi/${youtubeId}/${quality}.jpg`;
        }

        function getYouTubeEmbedUrl(youtubeId) {
            return `https://www.youtube.com/embed/${youtubeId}?autoplay=1`;
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown date';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // --- Firebase Authentication ---
        auth.onAuthStateChanged(user => {
            hideLoading();
            if (user) {
                currentUser = user;
                appContainer.classList.remove('hidden');
                authModal.style.display = 'none';
                console.log("User logged in:", currentUser.uid, currentUser.email || "Guest");
                updateProfileDisplay();
                fetchVideos(); // Fetch videos once user is authenticated
            } else {
                currentUser = null;
                appContainer.classList.add('hidden');
                showAuthModal();
            }
        });

        function showAuthModal() {
            authModal.style.display = 'flex';
        }

        authLoginButton.addEventListener('click', async () => {
            const email = authEmail.value;
            const password = authPassword.value;
            if (!email || !password) {
                authMessage.textContent = 'Please enter email and password.';
                return;
            }
            showLoading('Logging in...');
            try {
                await auth.signInWithEmailAndPassword(email, password);
                authMessage.textContent = '';
            } catch (error) {
                authMessage.textContent = error.message;
            } finally {
                hideLoading();
            }
        });

        authSignupButton.addEventListener('click', async () => {
            const email = authEmail.value;
            const password = authPassword.value;
            if (!email || !password) {
                authMessage.textContent = 'Please enter email and password.';
                return;
            }
            if (password.length < 6) {
                authMessage.textContent = 'Password must be at least 6 characters long.';
                return;
            }
            showLoading('Signing up...');
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await db.collection('artifacts').doc(appId).collection('users').doc(userCredential.user.uid).collection('profile').doc('data').set({
                    username: email.split('@')[0], // Default username
                    userId: userCredential.user.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                authMessage.textContent = 'Sign up successful! You are now logged in.';
            } catch (error) {
                authMessage.textContent = error.message;
            } finally {
                hideLoading();
            }
        });

        authGoogleSignIn.addEventListener('click', async () => {
            showLoading('Signing in with Google...');
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const userCredential = await auth.signInWithPopup(provider);
                // Check if profile exists, create if not
                const profileRef = db.collection('artifacts').doc(appId).collection('users').doc(userCredential.user.uid).collection('profile').doc('data');
                const profileDoc = await profileRef.get();
                if (!profileDoc.exists) {
                    await profileRef.set({
                        username: userCredential.user.displayName || userCredential.user.email.split('@')[0],
                        userId: userCredential.user.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                authMessage.textContent = '';
            } catch (error) {
                authMessage.textContent = error.message;
            } finally {
                hideLoading();
            }
        });

        authGuestButton.addEventListener('click', async () => {
            showLoading('Continuing as Guest...');
            try {
                await auth.signInAnonymously();
                authMessage.textContent = '';
            } catch (error) {
                authMessage.textContent = error.message;
            } finally {
                hideLoading();
            }
        });

        authForgotPassword.addEventListener('click', async () => {
            const email = authEmail.value;
            if (!email) {
                authMessage.textContent = 'Please enter your email to reset password.';
                return;
            }
            showLoading('Sending password reset email...');
            try {
                await auth.sendPasswordResetEmail(email);
                authMessage.textContent = 'Password reset email sent! Check your inbox.';
            } catch (error) {
                authMessage.textContent = error.message;
            } finally {
                hideLoading();
            }
        });

        signOutButton.addEventListener('click', async () => {
            showLoading('Signing out...');
            try {
                await auth.signOut();
                // Clear user data
                currentUser = null;
                // Redirect to home or login
                showSection('homeSection'); // Show home, which will then trigger auth modal
                authModal.style.display = 'flex'; // Explicitly show auth modal
            } catch (error) {
                console.error("Sign out error:", error);
                alert("Failed to sign out: " + error.message);
            } finally {
                hideLoading();
            }
        });

        // --- Profile Management ---
        async function updateProfileDisplay() {
            if (currentUser && !currentUser.isAnonymous) {
                profileUserId.textContent = `User ID: ${currentUser.uid}`;
                try {
                    const profileDoc = await db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('profile').doc('data').get();
                    if (profileDoc.exists) {
                        profileUsername.textContent = profileDoc.data().username || currentUser.email.split('@')[0];
                    } else {
                        profileUsername.textContent = currentUser.email.split('@')[0];
                        // Create a basic profile if it doesn't exist (e.g., for older users)
                        await db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('profile').doc('data').set({
                            username: currentUser.email.split('@')[0],
                            userId: currentUser.uid,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                    }
                } catch (error) {
                    console.error("Error fetching profile:", error);
                    profileUsername.textContent = currentUser.email.split('@')[0]; // Fallback
                }
            } else {
                profileUsername.textContent = 'Guest User';
                profileUserId.textContent = 'User ID: N/A (Guest)';
            }
            fetchMyVideos();
        }

        profileButton.addEventListener('click', () => {
            showSection('profileSection');
            updateProfileDisplay();
        });


        // --- Video Management (Upload, Fetch) ---
        uploadVideoButton.addEventListener('click', async () => {
            if (!currentUser || currentUser.isAnonymous) {
                uploadMessage.textContent = 'Error: Please sign in to upload videos.';
                uploadMessage.style.color = 'red';
                return;
            }

            const videoUrl = videoUrlInput.value.trim();
            const videoTitle = videoTitleInput.value.trim();
            const videoDescription = videoDescriptionInput.value.trim();
            const videoTags = videoTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
            const videoType = document.querySelector('input[name="videoType"]:checked').value;
            const videoVisibility = document.querySelector('input[name="videoVisibility"]:checked').value;

            if (!videoUrl || !videoTitle) {
                uploadMessage.textContent = 'Error: Video URL and Title are required.';
                uploadMessage.style.color = 'red';
                return;
            }

            const youtubeId = getYoutubeId(videoUrl);
            if (!youtubeId) {
                uploadMessage.textContent = 'Error: Invalid YouTube URL.';
                uploadMessage.style.color = 'red';
                return;
            }

            uploadMessage.textContent = 'Uploading video...';
            uploadMessage.style.color = 'yellow';
            showLoading('Uploading video details...');

            try {
                let uploaderUsername = 'Anonymous';
                const profileDoc = await db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('profile').doc('data').get();
                if (profileDoc.exists) {
                    uploaderUsername = profileDoc.data().username || currentUser.email.split('@')[0];
                }

                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('videos').add({
                    youtubeId: youtubeId,
                    url: videoUrl,
                    title: videoTitle,
                    description: videoDescription,
                    tags: videoTags,
                    videoType: videoType,
                    visibility: videoVisibility, // 'public' or 'private'
                    uploaderId: currentUser.uid,
                    uploaderName: uploaderUsername,
                    uploadDate: firebase.firestore.FieldValue.serverTimestamp(),
                    views: 0,
                    likes: 0,
                    monetization: {
                        vast: monetizeVast.checked,
                        banner468: monetizeBanner468.checked,
                        banner300: monetizeBanner300.checked,
                        native: monetizeNative.checked,
                    }
                });

                uploadMessage.textContent = 'Video uploaded successfully!';
                uploadMessage.style.color = 'green';
                setTimeout(() => {
                    closeUploadModal();
                    fetchVideos(); // Refresh videos after upload
                }, 1500);

            } catch (error) {
                console.error("Error uploading video:", error);
                uploadMessage.textContent = `Error uploading video: ${error.message}`;
                uploadMessage.style.color = 'red';
            } finally {
                hideLoading();
            }
        });

        async function fetchVideos() {
            showLoading('Fetching videos...');
            try {
                const videosRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('videos');
                const querySnapshot = await videosRef.orderBy('uploadDate', 'desc').get();
                const videos = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.visibility === 'public' || (currentUser && data.uploaderId === currentUser.uid)) {
                        videos.push({ id: doc.id, ...data });
                    }
                });
                renderVideos(videos);
            } catch (error) {
                console.error("Error fetching videos:", error);
                homeSection.innerHTML = '<p class="text-red-500 text-center">Failed to load videos. Please check your internet connection and Firebase rules.</p>';
            } finally {
                hideLoading();
            }
        }

        async function fetchMyVideos() {
            if (!currentUser || currentUser.isAnonymous) {
                myVideosList.innerHTML = '<p class="text-gray-400 text-center">Please sign in to view your uploaded videos.</p>';
                noVideosMessage.classList.add('hidden');
                return;
            }

            showLoading('Fetching your videos...');
            try {
                const videosRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('videos');
                const querySnapshot = await videosRef.where('uploaderId', '==', currentUser.uid).orderBy('uploadDate', 'desc').get();
                const myVideos = [];
                querySnapshot.forEach(doc => {
                    myVideos.push({ id: doc.id, ...doc.data() });
                });

                if (myVideos.length === 0) {
                    noVideosMessage.classList.remove('hidden');
                    myVideosList.innerHTML = '';
                } else {
                    noVideosMessage.classList.add('hidden');
                    renderVideoCards(myVideos, myVideosList, true); // Render as normal video cards
                }
            } catch (error) {
                console.error("Error fetching user videos:", error);
                myVideosList.innerHTML = '<p class="text-red-500 text-center">Failed to load your videos.</p>';
            } finally {
                hideLoading();
            }
        }

        function renderVideos(videos) {
            homeSection.innerHTML = '';
            shortsSection.innerHTML = '';

            const longVideos = videos.filter(v => v.videoType === 'normal');
            const shortVideos = videos.filter(v => v.videoType === 'short');

            // Render long videos for Home section
            renderVideoCards(longVideos, homeSection);

            // Render shorts for Shorts section
            shortVideos.forEach(video => {
                const shortsContainer = document.createElement('div');
                shortsContainer.className = 'w-full h-full flex flex-col justify-center items-center relative'; // Full screen for shorts
                shortsContainer.innerHTML = `
                    <div class="shorts-thumbnail-container w-full max-w-sm mx-auto">
                        <img src="${getYoutubeThumbnail(video.youtubeId, 'maxresdefault')}" alt="${video.title}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-4 w-full max-w-sm mx-auto">
                        <h3 class="text-lg font-bold">${video.title}</h3>
                        <p class="text-sm text-gray-400">${video.uploaderName}</p>
                        <p class="text-xs text-gray-500">${formatDate(video.uploadDate)}</p>
                    </div>
                `;
                shortsContainer.onclick = () => openVideoPlayerModal(video);
                shortsSection.appendChild(shortsContainer);
            });

            if (longVideos.length === 0 && shortVideos.length === 0) {
                homeSection.innerHTML = '<p class="text-gray-400 text-center col-span-full">No videos available yet. Be the first to upload!</p>';
            }
        }

        function renderVideoCards(videos, targetElement, showVisibility = false) {
            targetElement.innerHTML = '';
            videos.forEach(video => {
                const videoCard = document.createElement('div');
                videoCard.className = 'video-card shadow-lg';
                videoCard.innerHTML = `
                    <div class="thumbnail-container">
                        <img src="${getYoutubeThumbnail(video.youtubeId)}" alt="${video.title}">
                    </div>
                    <div class="p-4">
                        <h3 class="text-md font-bold mb-1 line-clamp-2">${video.title}</h3>
                        <p class="text-sm text-gray-400">${video.uploaderName}</p>
                        <p class="text-xs text-gray-500">${(video.views || 0).toLocaleString()} views â€¢ ${formatDate(video.uploadDate)}</p>
                        ${showVisibility ? `<p class="text-xs text-gray-500 mt-1">Visibility: ${video.visibility.charAt(0).toUpperCase() + video.visibility.slice(1)}</p>` : ''}
                    </div>
                `;
                videoCard.onclick = () => openVideoPlayerModal(video);
                targetElement.appendChild(videoCard);
            });
        }

        // --- Search Functionality ---
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        async function performSearch() {
            const query = searchInput.value.trim().toLowerCase();
            if (!query) {
                alert('Please enter a search query.');
                return;
            }

            showLoading(`Searching for "${query}"...`);
            try {
                const videosRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('videos');
                let allVideos = [];

                // Fetch all public videos and user's private videos
                const publicVideosSnapshot = await videosRef.where('visibility', '==', 'public').get();
                publicVideosSnapshot.forEach(doc => allVideos.push({ id: doc.id, ...doc.data() }));

                if (currentUser && !currentUser.isAnonymous) {
                    const privateVideosSnapshot = await videosRef.where('uploaderId', '==', currentUser.uid).where('visibility', '==', 'private').get();
                    privateVideosSnapshot.forEach(doc => allVideos.push({ id: doc.id, ...doc.data() }));
                }

                // Filter results client-side for now
                const searchResults = allVideos.filter(video =>
                    video.title.toLowerCase().includes(query) ||
                    (video.description && video.description.toLowerCase().includes(query)) ||
                    (video.uploaderName && video.uploaderName.toLowerCase().includes(query)) ||
                    (video.tags && video.tags.some(tag => tag.toLowerCase().includes(query)))
                );

                searchQueryDisplay.textContent = query;
                if (searchResults.length > 0) {
                    noSearchResultsMessage.classList.add('hidden');
                    renderVideoCards(searchResults, searchResultsList);
                } else {
                    noSearchResultsMessage.classList.remove('hidden');
                    searchResultsList.innerHTML = '';
                }
                showSection('searchResultsSection');

            } catch (error) {
                console.error("Error performing search:", error);
                searchResultsList.innerHTML = '<p class="text-red-500 text-center col-span-full">Failed to perform search. Please try again.</p>';
                noSearchResultsMessage.classList.add('hidden');
            } finally {
                hideLoading();
            }
        }


        // --- Video Player Functionality (Likes, Comments, Ads) ---

        // VAST Ad Setup and Play
        function requestVastAd(videoId) {
            console.log('Requesting VAST ad...');
            adDisplayContainer = new google.ima.AdDisplayContainer(vastAdContainer, youtubePlayer);
            adsLoader = new google.ima.AdsLoader(adDisplayContainer);
            adsLoader.addEventListener(
                google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,
                onAdsManagerLoaded,
                false
            );
            adsLoader.addEventListener(
                google.ima.AdErrorEvent.Type.AD_ERROR,
                onAdError,
                false
            );

            // Request video ads.
            const adsRequest = new google.ima.AdsRequest();
            // This is a sample VAST tag. Replace with your actual ad tag.
            // For testing, use Google's sample tags:
            // VAST 2.0: 'https://pubads.g.doubleclick.net/gampad/ads?sz=640x480&iu=/124319096/external/single_ad_samples&ciu_szs=300x250&impl=s&gdfp_req=1&env=vp&output=vast&unviewed_position_start=1&cust_params=deployment%3Ddevsite%26sample_ar%3Dpreonly&nofb=1&correlator='
            // VAST 3.0: 'https://pubads.g.doubleclick.net/gampad/ads?sz=640x480&iu=/124319096/external/single_ad_samples&ciu_szs=300x250&impl=s&gdfp_req=1&env=vp&output=vast&unviewed_position_start=1&cust_params=deployment%3Ddevsite%26sample_ar%3Dpreonly&nofb=1&correlator='
            // VMAP: 'https://pubads.g.doubleclick.net/gampad/ads?sz=640x480&iu=/124319096/external/vmap_ad_samples&ciu_szs=300x250&gdfp_req=1&ad_rule=1&env=vp&output=vmap&unviewed_position_start=1&impl=s&cmsid=496&vid=short_onecue&correlator='
            adsRequest.adTagUrl = 'https://pubads.g.doubleclick.net/gampad/ads?sz=640x480&iu=/124319096/external/single_ad_samples&ciu_szs=300x250&impl=s&gdfp_req=1&env=vp&output=vast&unviewed_position_start=1&cust_params=deployment%3Ddevsite%26sample_ar%3Dpreonly&nofb=1&correlator=';
            // You might want to make this dynamic or configurable

            adsRequest.linearAdSlotWidth = youtubePlayer.offsetWidth;
            adsRequest.linearAdSlotHeight = youtubePlayer.offsetHeight;
            adsRequest.nonLinearAdSlotWidth = youtubePlayer.offsetWidth;
            adsRequest.nonLinearAdSlotHeight = youtubePlayer.offsetHeight;

            adsLoader.requestAds(adsRequest);
            adPlayMessage.classList.remove('hidden');
        }

        function onAdsManagerLoaded(adsManagerLoadedEvent) {
            console.log('Ads Manager Loaded.');
            const adsRenderingSettings = new google.ima.AdsRenderingSettings();
            adsRenderingSettings.restoreCustomPlaybackStateOnAdBreakComplete = true;
            adsManager = adsManagerLoadedEvent.getAdsManager(youtubePlayer, adsRenderingSettings);
            adsManager.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR, onAdError);
            adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED, onContentPauseRequested);
            adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED, onContentResumeRequested);
            adsManager.addEventListener(google.ima.AdEvent.Type.LOADED, onAdLoaded); // Listen for AD_LOADED event

            try {
                adsManager.init(vastAdContainer.offsetWidth, vastAdContainer.offsetHeight, google.ima.ViewMode.NORMAL);
                adsManager.start();
            } catch (adError) {
                // An error may be thrown if there was a problem with the VAST response.
                console.error('Ads Manager initialization error:', adError);
                playVideoDirectly(currentVideoData.youtubeId);
            }
        }

        function onAdError(adErrorEvent) {
            // Handle the error logging.
            console.error('Ad Error:', adErrorEvent.getError());
            // Play content.
            playVideoDirectly(currentVideoData.youtubeId);
        }

        function onContentPauseRequested() {
            // This function is called when the ad starts playing.
            youtubePlayer.src = ''; // Pause/Stop YouTube content
            vastAdContainer.style.display = 'block';
            contentPlayer.style.display = 'none';
            adPlayMessage.classList.remove('hidden');
        }

        function onContentResumeRequested() {
            // This function is called when the ad is finished.
            vastAdContainer.style.display = 'none';
            adPlayMessage.classList.add('hidden');
            contentPlayer.style.display = 'block';
            playVideoDirectly(currentVideoData.youtubeId);
        }

        function onAdLoaded(adEvent) {
            const ad = adEvent.getAd();
            if (!ad.isLinear()) {
                // Non-linear ad.
                // Do nothing specific for now, as we only expect pre-roll linear ads
            }
        }

        function playVideoDirectly(youtubeId) {
            vastAdContainer.style.display = 'none';
            adPlayMessage.classList.add('hidden');
            contentPlayer.style.display = 'block';
            youtubePlayer.src = getYouTubeEmbedUrl(youtubeId);
            // Increment view count
            incrementVideoView(currentVideoData.id);
        }

        // Ad loading based on monetization settings
        function loadDynamicAds(monetizationSettings) {
            adContainerVideoPlayer.innerHTML = ''; // Clear previous ads

            if (monetizationSettings.banner468) {
                const banner468 = document.createElement('div');
                banner468.className = 'ad-banner-468x60 mx-auto';
                banner468.textContent = 'Banner Ad 468x60';
                adContainerVideoPlayer.appendChild(banner468);
            }

            if (monetizationSettings.banner300) {
                const banner300 = document.createElement('div');
                banner300.className = 'ad-banner-300x250 mx-auto';
                banner300.textContent = 'Banner Ad 300x250';
                adContainerVideoPlayer.appendChild(banner300);
            }

            if (monetizationSettings.native) {
                const nativeAd = document.createElement('div');
                nativeAd.className = 'ad-native mx-auto';
                nativeAd.innerHTML = `
                    <div class="ad-title">Sponsored Content</div>
                    <div class="ad-description">This is a native advertisement. You can customize its content.</div>
                    <div class="ad-cta">Learn More</div>
                `;
                adContainerVideoPlayer.appendChild(nativeAd);
            }
        }

        // Like functionality
        async function updateLikeButtonState(videoId) {
            if (!currentUser || currentUser.isAnonymous) {
                likeButton.disabled = true;
                likeButton.style.opacity = 0.5;
                return;
            }
            likeButton.disabled = false;
            likeButton.style.opacity = 1;

            const likeRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('videos').doc(videoId).collection('likes').doc(currentUser.uid);
            const doc = await likeRef.get();
            if (doc.exists) {
                likeButton.classList.add('text-red-500'); // Indicate liked state
            } else {
                likeButton.classList.remove('text-red-500');
            }
        }

        likeButton.addEventListener('click', async () => {
            if (!currentUser || currentUser.isAnonymous || !currentVideoData) {
                alert('Please sign in to like videos.');
                return;
            }

            const videoId = currentVideoData.id;
            const likeRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('videos').doc(videoId).collection('likes').doc(currentUser.uid);

            try {
                const doc = await likeRef.get();
                if (doc.exists) {
                    // Unlike
                    await likeRef.delete();
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('videos').doc(videoId).update({
                        likes: firebase.firestore.FieldValue.increment(-1)
                    });
                    likeButton.classList.remove('text-red-500');
                    likeCount.textContent = parseInt(likeCount.textContent) - 1;
                } else {
                    // Like
                    await likeRef.set({
                        userId: currentUser.uid,
                        likedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('videos').doc(videoId).update({
                        likes: firebase.firestore.FieldValue.increment(1)
                    });
                    likeButton.classList.add('text-red-500');
                    likeCount.textContent = parseInt(likeCount.textContent) + 1;
                }
            } catch (error) {
                console.error("Error liking/unliking video:", error);
                alert("Failed to update like: " + error.message);
            }
        });

        // Share functionality
        shareButton.addEventListener('click', () => {
            if (currentVideoData && currentVideoData.url) {
                if (navigator.share) {
                    navigator.share({
                        title: currentVideoData.title,
                        text: `Check out this video: ${currentVideoData.title}`,
                        url: currentVideoData.url,
                    }).then(() => console.log('Successful share'))
                      .catch((error) => console.log('Error sharing', error));
                } else {
                    // Fallback for browsers that don't support Web Share API
                    prompt('Copy this link to share:', currentVideoData.url);
                }
            } else {
                alert('No video selected to share.');
            }
        });


        // Comment functionality
        commentButton.addEventListener('click', async () => {
            if (!currentUser || currentUser.isAnonymous || !currentVideoData) {
                alert('Please sign in to comment.');
                return;
            }

            const commentText = commentInput.value.trim();
            if (!commentText) {
                alert('Comment cannot be empty.');
                return;
            }

            const videoId = currentVideoData.id;
            let commenterName = 'Anonymous';
            try {
                const profileDoc = await db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('profile').doc('data').get();
                if (profileDoc.exists) {
                    commenterName = profileDoc.data().username || currentUser.email.split('@')[0];
                }
            } catch (error) {
                console.error("Error fetching commenter name:", error);
            }

            try {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('videos').doc(videoId).collection('comments').add({
                    userId: currentUser.uid,
                    username: commenterName,
                    text: commentText,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                commentInput.value = '';
                fetchComments(videoId); // Refresh comments
            } catch (error) {
                console.error("Error adding comment:", error);
                alert("Failed to add comment: " + error.message);
            }
        });

        async function fetchComments(videoId) {
            commentsList.innerHTML = ''; // Clear existing comments
            try {
                const commentsRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('videos').doc(videoId).collection('comments');
                const querySnapshot = await commentsRef.orderBy('createdAt', 'asc').get();
                if (querySnapshot.empty) {
                    commentsList.innerHTML = '<p class="text-gray-500 text-center">No comments yet. Be the first to comment!</p>';
                    return;
                }
                querySnapshot.forEach(doc => {
                    const comment = doc.data();
                    const commentItem = document.createElement('div');
                    commentItem.className = 'comment-item';
                    commentItem.innerHTML = `
                        <strong>${comment.username}</strong>
                        <p class="text-sm text-gray-300">${comment.text}</p>
                        <span class="text-xs text-gray-500">${formatDate(comment.createdAt)}</span>
                    `;
                    commentsList.appendChild(commentItem);
                });
            } catch (error) {
                console.error("Error fetching comments:", error);
                commentsList.innerHTML = '<p class="text-red-500 text-center">Failed to load comments.</p>';
            }
        }

        // Increment video view count
        async function incrementVideoView(videoId) {
            try {
                const videoRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('videos').doc(videoId);
                await videoRef.update({
                    views: firebase.firestore.FieldValue.increment(1)
                });
                console.log(`View count incremented for video ${videoId}`);
                // Optionally, update the displayed view count without re-fetching all videos
                if (currentVideoData && currentVideoData.id === videoId) {
                    currentVideoData.views = (currentVideoData.views || 0) + 1;
                    videoPlayerViews.textContent = `${(currentVideoData.views).toLocaleString()} views`;
                }
            } catch (error) {
                console.error("Error incrementing view count:", error);
            }
        }

        // Initial load
        showLoading('Initializing...');
        // The onAuthStateChanged listener handles showing the app or auth modal
    </script>
</body>
</html>
