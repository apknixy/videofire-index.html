<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoFire</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <section id="login-screen" class="screen">
        <div class="welcome-container">
            <h1>Welcome to VideoFire</h1>
            <p>Your new video sharing platform.</p>
            <button onclick="signInWithGoogle()">Sign in with Google</button>
        </div>
    </section>

    <section id="channel-creation-screen" class="screen" style="display:none;">
        <div class="channel-create-container">
            <h2>Create Your Channel</h2>
            <p>Choose a unique channel name. This cannot be changed later.</p>
            <input type="text" id="channel-name-input" placeholder="Enter channel name">
            <p>Choose a Profile Picture</p>
            <input type="file" id="profile-picture-input" accept="image/*">
            <button onclick="createChannel()">Create Channel</button>
        </div>
    </section>

    <section id="main-app-screen" class="screen" style="display:none;">
        <header class="app-header">
            <div class="logo">VideoFire</div>
            <nav class="main-nav">
                <button onclick="showSection('home-section')">Home</button>
                <button onclick="showSection('shorts-section')">Shorts</button>
                <button onclick="showSection('upload-section')">Upload</button>
                <button onclick="showSection('profile-section')">Profile</button>
                <input type="text" id="search-input" placeholder="Search videos, channels..." onkeyup="performSearch()">
            </nav>
        </header>

        <main class="app-content">
            <section id="home-section" class="content-section active">
                <h2>Home Feed</h2>
                <div id="video-feed">
                    </div>
            </section>

            <section id="shorts-section" class="content-section">
                <h2>Shorts</h2>
                <div id="shorts-list">
                    </div>
            </section>

            <section id="upload-section" class="content-section">
                <h2>Upload Video</h2>
                <div class="upload-options">
                    <button onclick="showUploadForm('short')">Upload Short</button>
                    <button onclick="showUploadForm('video')">Upload Video</button>
                </div>
                <div id="upload-form-container" style="display: none;">
                    <form id="video-upload-form">
                        <input type="hidden" id="upload-type" value="">
                        <label for="video-file-input">Select Video File:</label>
                        <input type="file" id="video-file-input" accept="video/*" onchange="handleVideoFileSelect(event)">
                        <label for="video-thumbnail-input">Select Thumbnail Image:</label>
                        <input type="file" id="video-thumbnail-input" accept="image/*">
                        <label for="video-title">Title:</label>
                        <input type="text" id="video-title" maxlength="100" placeholder="Minimum 2-3 words, Max 100">
                        <label for="video-description">Description:</label>
                        <textarea id="video-description" maxlength="4000" placeholder="Max 4000 words"></textarea>
                        <label for="video-tags">Tags (comma separated):</label>
                        <input type="text" id="video-tags" maxlength="500" placeholder="e.g., gaming, tutorial, vlog">
                        <button type="submit" onclick="uploadVideo(event)">Upload</button>
                    </form>
                </div>
            </section>

            <section id="profile-section" class="content-section">
                <h2>My Channel</h2>
                <div id="profile-info">
                    </div>
                <button onclick="signOutUser()">Sign Out</button>
            </section>

            <section id="search-screen" class="content-section">
                <h2>Search Results</h2>
                <div id="search-results">
                    </div>
            </section>
        </main>
    </section>

    <section id="video-playback-screen" class="screen" style="display:none;">
        <button onclick="hideVideoPlayback()">Back</button>
        <div id="video-player-container">
            <video id="main-video-player" controls></video>
            <div id="vast-ad-player" style="display: none;"></div>
        </div>
        <h3 id="video-playback-title"></h3>
        <p id="video-playback-views"></p>
        <p id="video-playback-description"></p>
        <div class="video-actions">
            <button onclick="likeVideo()"><img src="like_icon.png" alt="Like"> <span id="like-count">0</span></button>
            <button onclick="shareVideo()"><img src="share_icon.png" alt="Share"></button>
            <button onclick="showComments()"><img src="comment_icon.png" alt="Comment"></button>
        </div>
        <div id="comments-section" style="display: none;">
            <h4>Comments</h4>
            <ul id="comments-list"></ul>
            <textarea id="new-comment-input" placeholder="Add a comment..."></textarea>
            <button onclick="postComment()">Post Comment</button>
        </div>
        <div id="suggested-videos">
            <h4>More videos</h4>
            </div>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDes3ioeygnWBqJB6NnHb7xj732JJhOqm8",
            authDomain: "videofire-268ff.firebaseapp.com",
            databaseURL: "https://videofire-268ff-default-rtdb.firebaseio.com",
            projectId: "videofire-268ff",
            storageBucket: "videofire-268ff.firebasestorage.app",
            messagingSenderId: "910374058927",
            appId: "1:910374058927:web:6add3afdea07cfa2914d5a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Google Sign-In function
        window.signInWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // User signed in successfully, onAuthStateChanged will handle UI update
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                // You might want to display a user-friendly error message here
            }
        };

        // Check auth state persistence
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in.
                console.log("User logged in:", user.displayName, user.email, user.uid);

                const userRef = ref(database, 'users/' + user.uid);
                const snapshot = await get(child(userRef, 'channelName'));

                if (!snapshot.exists()) {
                    // Show channel name creation screen
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-app-screen').style.display = 'none';
                    document.getElementById('channel-creation-screen').style.display = 'block';
                } else {
                    // Channel name exists, proceed to home
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('channel-creation-screen').style.display = 'none';
                    document.getElementById('main-app-screen').style.display = 'block';
                    loadHomePage(); // Function to load home content
                }
            } else {
                // User is signed out.
                console.log("User logged out.");
                document.getElementById('login-screen').style.display = 'block';
                document.getElementById('main-app-screen').style.display = 'none';
                document.getElementById('channel-creation-screen').style.display = 'none';
                document.getElementById('video-playback-screen').style.display = 'none'; // Hide playback if user logs out
                document.getElementById('search-screen').style.display = 'none'; // Hide search if user logs out
            }
        });

        window.signOutUser = () => {
            signOut(auth).then(() => {
                // Sign-out successful. onAuthStateChanged will handle UI update.
            }).catch((error) => {
                console.error("Sign Out Error:", error);
            });
        };

        // --- UI Navigation Functions ---
        window.showSection = (sectionId) => {
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';
        };

        // --- Placeholder Functions (You'll implement these fully) ---
        async function createChannel() {
            const user = auth.currentUser;
            if (user) {
                const channelName = document.getElementById('channel-name-input').value.trim();
                const profilePictureFile = document.getElementById('profile-picture-input').files[0];

                if (channelName) {
                    try {
                        // Check if channel name is already taken (implement this logic)
                        const channelNamesRef = ref(database, 'channelNames');
                        const snapshot = await get(child(channelNamesRef, channelName.toLowerCase()));

                        if (snapshot.exists()) {
                            alert("This channel name is already taken. Please choose another.");
                            return;
                        }

                        // Save channel name and user ID mapping
                        await set(child(channelNamesRef, channelName.toLowerCase()), user.uid);

                        // Save user's channel details
                        const userRef = ref(database, 'users/' + user.uid);
                        await set(userRef, {
                            uid: user.uid,
                            email: user.email,
                            displayName: user.displayName,
                            channelName: channelName,
                            // You'll handle profile picture upload to Storage here
                            profilePictureUrl: profilePictureFile ? 'URL_TO_PROFILE_PIC' : '' // Placeholder
                        });

                        alert("Channel created successfully!");
                        // Redirect to main app screen after channel creation
                        document.getElementById('channel-creation-screen').style.display = 'none';
                        document.getElementById('main-app-screen').style.display = 'block';
                        loadHomePage(); // Load home content after creation
                    } catch (error) {
                        console.error("Error creating channel:", error);
                        alert("Failed to create channel. Please try again.");
                    }
                } else {
                    alert("Please enter a channel name.");
                }
            } else {
                alert("You must be logged in to create a channel.");
            }
        }

        function loadHomePage() {
            console.log("Loading Home Page...");
            // Your logic to load and display videos on the home page
            // For example, fetch videos from Firebase Realtime Database
            showSection('home-section'); // Ensure home section is visible
        }

        function showUploadForm(type) {
            document.getElementById('upload-type').value = type;
            document.getElementById('upload-form-container').style.display = 'block';
            console.log(`Showing upload form for ${type}`);
        }

        function handleVideoFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                console.log("Selected video file:", file.name);
            }
        }

        function uploadVideo(event) {
            event.preventDefault(); // Prevent default form submission
            const uploadType = document.getElementById('upload-type').value;
            const videoFile = document.getElementById('video-file-input').files[0];
            const thumbnailFile = document.getElementById('video-thumbnail-input').files[0];
            const title = document.getElementById('video-title').value;
            const description = document.getElementById('video-description').value;
            const tags = document.getElementById('video-tags').value;

            if (!videoFile || !title) {
                alert("Please select a video file and enter a title.");
                return;
            }

            console.log(`Uploading ${uploadType}:`, { videoFile, thumbnailFile, title, description, tags });
            alert("Upload functionality is not yet fully implemented. Check console for details.");
            // Here you'll add logic to upload files to Firebase Storage
            // and then save video metadata to Firebase Realtime Database
        }

        function hideVideoPlayback() {
            document.getElementById('video-playback-screen').style.display = 'none';
            document.getElementById('main-app-screen').style.display = 'block';
            document.getElementById('main-video-player').pause(); // Pause video when hiding
            document.getElementById('main-video-player').src = ''; // Clear video source
        }

        function likeVideo() {
            alert("Like video functionality goes here!");
        }

        function shareVideo() {
            alert("Share video functionality goes here!");
        }

        function showComments() {
            const commentsSection = document.getElementById('comments-section');
            commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
        }

        function postComment() {
            const newCommentInput = document.getElementById('new-comment-input');
            const commentText = newCommentInput.value.trim();
            if (commentText) {
                alert(`Posting comment: "${commentText}"`);
                newCommentInput.value = ''; // Clear input
                // Logic to save comment to Firebase Realtime Database
            }
        }

        function performSearch() {
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            console.log("Performing search for:", searchInput);
            // Logic to search videos/channels in Firebase Realtime Database
            // and display results in #search-results
            // You might want to show the search-screen section here:
            // document.getElementById('main-app-screen').style.display = 'none';
            // document.getElementById('search-screen').style.display = 'block';
        }

        // Initial setup to show the correct screen based on auth state
        // This will be handled by onAuthStateChanged, but good to have a default
        // if auth state is not immediately known or if there's a delay.
        // For now, onAuthStateChanged covers this well.

    </script>
</body>
</html>
